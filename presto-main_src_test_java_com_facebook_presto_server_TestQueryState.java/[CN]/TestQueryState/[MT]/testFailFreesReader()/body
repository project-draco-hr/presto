{
  PageBuffer pageBuffer=new PageBuffer("bufferId",1,5);
  assertRunning(pageBuffer);
  ExecutorService executor=Executors.newCachedThreadPool();
  GetPagesJob getPagesJob=new GetPagesJob(pageBuffer,2,1);
  executor.submit(getPagesJob);
  getPagesJob.waitForStarted();
  getPagesJob.assertBlockedWithCount(0);
  pageBuffer.addPage(createLongPage(0));
  getPagesJob.assertBlockedWithCount(1);
  RuntimeException exception=new RuntimeException("failed");
  pageBuffer.queryFailed(exception);
  assertFailed(pageBuffer,exception);
  getPagesJob.waitForFinished();
  assertEquals(getPagesJob.getPages().size(),1);
  assertFailedQuery(getPagesJob.getFailedQueryException(),exception);
}
