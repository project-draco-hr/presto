{
  QueryState queryState=new QueryState(1,5);
  assertRunning(queryState);
  ExecutorService executor=Executors.newCachedThreadPool();
  for (int i=0; i < 5; i++) {
    queryState.addBlock(Blocks.createLongsBlock(i,i));
  }
  AddBlocksJob addBlocksJob=new AddBlocksJob(queryState,Blocks.createLongsBlock(2,2),Blocks.createLongsBlock(3,3));
  executor.submit(addBlocksJob);
  addBlocksJob.waitForStarted();
  addBlocksJob.assertBlockedWithCount(2);
  assertEquals(queryState.getNextBlocks(1).size(),1);
  addBlocksJob.assertBlockedWithCount(1);
  RuntimeException exception=new RuntimeException("failed");
  queryState.queryFailed(exception);
  assertFailed(queryState,exception);
  addBlocksJob.waitForFinished();
}
