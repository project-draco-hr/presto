{
  QueryState queryState=new QueryState(TUPLE_INFOS,1,5);
  assertRunning(queryState);
  ExecutorService executor=Executors.newCachedThreadPool();
  for (int i=0; i < 5; i++) {
    queryState.addPage(createLongPage(i,i));
  }
  AddPagesJob addPagesJob=new AddPagesJob(queryState,createLongPage(2,2),createLongPage(3,3));
  executor.submit(addPagesJob);
  addPagesJob.waitForStarted();
  addPagesJob.assertBlockedWithCount(2);
  assertEquals(queryState.getNextPages(1,MAX_WAIT).size(),1);
  addPagesJob.assertBlockedWithCount(1);
  RuntimeException exception=new RuntimeException("failed");
  queryState.queryFailed(exception);
  assertFailed(queryState,exception);
  addPagesJob.waitForFinished();
}
