{
  QueryState queryState=new QueryState(1,20);
  assertRunning(queryState);
  for (int i=0; i < 5; i++) {
    queryState.addBlock(Blocks.createLongsBlock(i,i));
  }
  assertRunning(queryState);
  List<UncompressedBlock> nextBlocks=queryState.getNextBlocks(2);
  assertEquals(nextBlocks.size(),2);
  assertEquals(getBlockOnlyValue(nextBlocks.get(0)),0);
  assertEquals(getBlockOnlyValue(nextBlocks.get(1)),1);
  assertRunning(queryState);
  nextBlocks=queryState.getNextBlocks(2);
  assertEquals(nextBlocks.size(),2);
  assertEquals(getBlockOnlyValue(nextBlocks.get(0)),2);
  assertEquals(getBlockOnlyValue(nextBlocks.get(1)),3);
  assertRunning(queryState);
  RuntimeException exception=new RuntimeException("failed");
  queryState.queryFailed(exception);
  assertFailed(queryState,exception);
  queryState.addBlock(Blocks.createLongsBlock(22,22));
  assertFailed(queryState,exception);
  RuntimeException anotherException=new RuntimeException("failed again");
  queryState.queryFailed(anotherException);
  assertFailed(queryState,exception,anotherException);
  queryState.cancel();
  assertFailed(queryState,exception,anotherException);
  queryState.cancel();
  assertFailed(queryState,exception,anotherException);
  queryState.sourceFinished();
  assertFailed(queryState,exception,anotherException);
}
