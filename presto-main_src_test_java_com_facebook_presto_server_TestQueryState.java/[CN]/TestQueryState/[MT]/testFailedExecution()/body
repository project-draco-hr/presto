{
  PageBuffer pageBuffer=new PageBuffer("bufferId",ImmutableList.of(SINGLE_LONG),1,20);
  assertRunning(pageBuffer);
  for (int i=0; i < 5; i++) {
    pageBuffer.addPage(createLongPage(i));
  }
  assertRunning(pageBuffer);
  List<Page> nextPages=pageBuffer.getNextPages(2,MAX_WAIT);
  assertEquals(nextPages.size(),2);
  assertEquals(getPageOnlyValue(nextPages.get(0)),0);
  assertEquals(getPageOnlyValue(nextPages.get(1)),1);
  assertRunning(pageBuffer);
  nextPages=pageBuffer.getNextPages(2,MAX_WAIT);
  assertEquals(nextPages.size(),2);
  assertEquals(getPageOnlyValue(nextPages.get(0)),2);
  assertEquals(getPageOnlyValue(nextPages.get(1)),3);
  assertRunning(pageBuffer);
  RuntimeException exception=new RuntimeException("failed");
  pageBuffer.queryFailed(exception);
  assertFailed(pageBuffer,exception);
  pageBuffer.addPage(createLongPage(22));
  assertFailed(pageBuffer,exception);
  RuntimeException anotherException=new RuntimeException("failed again");
  pageBuffer.queryFailed(anotherException);
  assertFailed(pageBuffer,exception,anotherException);
  pageBuffer.finish();
  assertFailed(pageBuffer,exception,anotherException);
  pageBuffer.finish();
  assertFailed(pageBuffer,exception,anotherException);
  pageBuffer.sourceFinished();
  assertFailed(pageBuffer,exception,anotherException);
}
