{
  QueryState queryState=new QueryState(ImmutableList.of(SINGLE_LONG),1,20);
  assertRunning(queryState);
  for (int i=0; i < 5; i++) {
    queryState.addPage(createLongPage(i,i));
  }
  assertRunning(queryState);
  List<Page> nextPages=queryState.getNextPages(2,MAX_WAIT);
  assertEquals(nextPages.size(),2);
  assertEquals(getPageOnlyValue(nextPages.get(0)),0);
  assertEquals(getPageOnlyValue(nextPages.get(1)),1);
  assertRunning(queryState);
  nextPages=queryState.getNextPages(2,MAX_WAIT);
  assertEquals(nextPages.size(),2);
  assertEquals(getPageOnlyValue(nextPages.get(0)),2);
  assertEquals(getPageOnlyValue(nextPages.get(1)),3);
  assertRunning(queryState);
  nextPages=queryState.getNextPages(2,MAX_WAIT);
  assertEquals(nextPages.size(),1);
  assertEquals(getPageOnlyValue(nextPages.get(0)),4);
  assertRunning(queryState);
  int position=9;
  int value=9;
  queryState.addPage(createLongPage(position,value));
  queryState.sourceFinished();
  assertRunning(queryState);
  nextPages=queryState.getNextPages(2,MAX_WAIT);
  assertEquals(nextPages.size(),1);
  assertEquals(getPageOnlyValue(nextPages.get(0)),9);
  assertFinished(queryState);
  try {
    queryState.addPage(createLongPage(22,22));
    fail("expected IllegalStateException");
  }
 catch (  IllegalStateException e) {
  }
  assertFinished(queryState);
  queryState.sourceFinished();
  assertFinished(queryState);
  queryState.queryFailed(new RuntimeException());
  assertFinished(queryState);
  queryState.cancel();
  assertFinished(queryState);
}
