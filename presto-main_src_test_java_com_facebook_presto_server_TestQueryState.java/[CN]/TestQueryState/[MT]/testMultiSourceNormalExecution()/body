{
  PageBuffer pageBuffer=new PageBuffer(TUPLE_INFOS,3,20);
  assertRunning(pageBuffer);
  pageBuffer.addPage(createLongPage(0));
  pageBuffer.addPage(createLongPage(1));
  assertRunning(pageBuffer);
  List<Page> nextPages=pageBuffer.getNextPages(2,MAX_WAIT);
  assertEquals(nextPages.size(),2);
  assertEquals(getPageOnlyValue(nextPages.get(0)),0);
  assertEquals(getPageOnlyValue(nextPages.get(1)),1);
  assertRunning(pageBuffer);
  pageBuffer.sourceFinished();
  assertRunning(pageBuffer);
  pageBuffer.addPage(createLongPage(9));
  pageBuffer.sourceFinished();
  assertRunning(pageBuffer);
  nextPages=pageBuffer.getNextPages(2,MAX_WAIT);
  assertEquals(nextPages.size(),1);
  assertEquals(getPageOnlyValue(nextPages.get(0)),9);
  assertRunning(pageBuffer);
  pageBuffer.sourceFinished();
  assertFinished(pageBuffer);
  assertFalse(pageBuffer.addPage(createLongPage(22)));
  assertFinished(pageBuffer);
  pageBuffer.sourceFinished();
  assertFinished(pageBuffer);
  pageBuffer.queryFailed(new RuntimeException());
  assertFinished(pageBuffer);
  pageBuffer.finish();
  assertFinished(pageBuffer);
}
