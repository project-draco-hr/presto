{
  PhysicalOperation source=sourceNode.accept(this,context);
  Map<Input,Type> sourceTypes=getInputTypes(source.getLayout(),source.getTupleInfos());
  ImmutableMultimap.Builder<Symbol,Input> outputMappingsBuilder=ImmutableMultimap.builder();
  for (int i=0; i < outputSymbols.size(); i++) {
    Symbol symbol=outputSymbols.get(i);
    outputMappingsBuilder.put(symbol,new Input(i,0));
  }
  Multimap<Symbol,Input> outputMappings=outputMappingsBuilder.build();
  try {
    SymbolToInputRewriter symbolToInputRewriter=new SymbolToInputRewriter(convertLayoutToInputMap(source.getLayout()));
    Expression rewrittenFilter=ExpressionTreeRewriter.rewriteWith(symbolToInputRewriter,filterExpression);
    List<Expression> rewrittenProjections=new ArrayList<>();
    for (    Expression projection : projectionExpressions) {
      rewrittenProjections.add(ExpressionTreeRewriter.rewriteWith(symbolToInputRewriter,projection));
    }
    NewOperatorFactory operatorFactory=compiler.compileFilterAndProjectOperator(context.getNextOperatorId(),rewrittenFilter,rewrittenProjections,sourceTypes);
    return new PhysicalOperation(operatorFactory,outputMappings,source);
  }
 catch (  Exception e) {
    log.error(e,"Compile failed for filter=%s projections=%s sourceTypes=%s error=%s",filterExpression,projectionExpressions,sourceTypes,e);
  }
  FilterFunction filterFunction;
  if (filterExpression != BooleanLiteral.TRUE_LITERAL) {
    filterFunction=new InterpretedFilterFunction(filterExpression,convertLayoutToInputMap(source.getLayout()),metadata,context.getSession(),sourceTypes);
  }
 else {
    filterFunction=FilterFunctions.TRUE_FUNCTION;
  }
  List<ProjectionFunction> projectionFunctions=new ArrayList<>();
  for (int i=0; i < projectionExpressions.size(); i++) {
    Symbol symbol=outputSymbols.get(i);
    Expression expression=projectionExpressions.get(i);
    ProjectionFunction function;
    if (expression instanceof QualifiedNameReference) {
      Symbol reference=Symbol.fromQualifiedName(((QualifiedNameReference)expression).getName());
      function=ProjectionFunctions.singleColumn(context.getTypes().get(reference).getRawType(),getFirst(source.getLayout().get(symbol)));
    }
 else {
      function=new InterpretedProjectionFunction(context.getTypes().get(symbol),expression,convertLayoutToInputMap(source.getLayout()),metadata,context.getSession(),sourceTypes);
    }
    projectionFunctions.add(function);
  }
  if (sourceNode instanceof TableScanNode) {
    TableScanNode tableScanNode=(TableScanNode)sourceNode;
    List<ColumnHandle> columns=new ArrayList<>();
    for (    Symbol symbol : tableScanNode.getOutputSymbols()) {
      columns.add(tableScanNode.getAssignments().get(symbol));
    }
    NewOperatorFactory operatorFactory=new NewScanFilterAndProjectOperatorFactory(context.getNextOperatorId(),tableScanNode.getId(),dataStreamProvider,columns,filterFunction,projectionFunctions);
    return new PhysicalOperation(operatorFactory,outputMappings);
  }
 else {
    NewOperatorFactory operatorFactory=new NewFilterAndProjectOperatorFactory(context.getNextOperatorId(),filterFunction,projectionFunctions);
    return new PhysicalOperation(operatorFactory,outputMappings,source);
  }
}
