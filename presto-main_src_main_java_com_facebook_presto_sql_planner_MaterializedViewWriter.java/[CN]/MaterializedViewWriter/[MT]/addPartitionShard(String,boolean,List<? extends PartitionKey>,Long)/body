{
  PartitionInfo partitionInfo=openPartitions.get(partition);
  ImmutableSet.Builder<Long> builder=ImmutableSet.builder();
  if (partitionInfo != null) {
    Set<Long> partitionSplits=partitionInfo.getShardIds();
    builder.addAll(partitionSplits);
  }
  if (shardId != null) {
    builder.add(shardId);
  }
 else {
    checkState(lastSplit,"shardId == null and lastSplit unset!");
  }
  Set<Long> shardIds=builder.build();
  checkState(!shardIds.isEmpty(),"Never saw a split for partition %s",partition);
  PartitionInfo newPartitionInfo=new PartitionInfo(shardIds,partitionKeys);
  if (lastSplit) {
    checkState(null == finishedPartitions.put(partition,newPartitionInfo),"Partition %s finished multiple times",partition);
    openPartitions.remove(partition);
  }
 else {
    openPartitions.put(partition,newPartitionInfo);
  }
}
