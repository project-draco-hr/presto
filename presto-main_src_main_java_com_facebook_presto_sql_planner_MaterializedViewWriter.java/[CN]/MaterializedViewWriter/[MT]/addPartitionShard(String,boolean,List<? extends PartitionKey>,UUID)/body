{
  PartitionInfo partitionInfo=openPartitions.get(partition);
  ImmutableSet.Builder<UUID> builder=ImmutableSet.builder();
  if (partitionInfo != null) {
    Set<UUID> partitionSplits=partitionInfo.getShardUuids();
    builder.addAll(partitionSplits);
  }
  if (shardUuid != null) {
    builder.add(shardUuid);
  }
 else {
    checkState(lastSplit,"shardUuid == null and lastSplit unset!");
  }
  Set<UUID> shardUuids=builder.build();
  checkState(!shardUuids.isEmpty(),"Never saw a split for partition %s",partition);
  PartitionInfo newPartitionInfo=new PartitionInfo(shardUuids,partitionKeys);
  if (lastSplit) {
    checkState(null == finishedPartitions.put(partition,newPartitionInfo),"Partition %s finished multiple times",partition);
    openPartitions.remove(partition);
  }
 else {
    openPartitions.put(partition,newPartitionInfo);
  }
}
