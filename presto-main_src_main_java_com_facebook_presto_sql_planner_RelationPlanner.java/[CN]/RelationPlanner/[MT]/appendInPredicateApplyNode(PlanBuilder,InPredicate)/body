{
  checkState(inPredicate.getValueList() instanceof SubqueryExpression);
  SubqueryExpression subqueryExpression=(SubqueryExpression)inPredicate.getValueList();
  RelationPlanner relationPlanner=new RelationPlanner(analysis,symbolAllocator,idAllocator,metadata,session);
  PlanNode valueListRelation=relationPlanner.process(subqueryExpression.getQuery(),null).getRoot();
  subPlan=appendProjections(subPlan,ImmutableList.of(inPredicate.getValue()));
  TranslationMap translations=new TranslationMap(subPlan.getRelationPlan(),analysis);
  translations.copyMappingsFrom(subPlan.getTranslations());
  QualifiedNameReference valueList=Iterables.getOnlyElement(valueListRelation.getOutputSymbols()).toQualifiedNameReference();
  translations.setExpressionAsAlreadyTranslated(valueList);
  translations.put(inPredicate,new InPredicate(inPredicate.getValue(),valueList));
  return new PlanBuilder(translations,new ApplyNode(idAllocator.getNextId(),subPlan.getRoot(),valueListRelation,ImmutableList.of()),subPlan.getSampleWeight());
}
