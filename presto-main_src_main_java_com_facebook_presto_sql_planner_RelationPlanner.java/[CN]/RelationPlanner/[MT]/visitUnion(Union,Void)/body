{
  checkArgument(!node.getRelations().isEmpty(),"No relations specified for UNION");
  List<Symbol> unionOutputSymbols=null;
  ImmutableList.Builder<PlanNode> sources=ImmutableList.builder();
  ImmutableListMultimap.Builder<Symbol,Symbol> symbolMapping=ImmutableListMultimap.builder();
  for (  Relation relation : node.getRelations()) {
    RelationPlan relationPlan=process(relation,context);
    List<Symbol> childOutputSymobls=relationPlan.getOutputSymbols();
    if (unionOutputSymbols == null) {
      TupleDescriptor descriptor=relationPlan.getDescriptor();
      ImmutableList.Builder<Symbol> outputSymbolBuilder=ImmutableList.builder();
      for (      Field field : descriptor.getVisibleFields()) {
        int fieldIndex=descriptor.indexOf(field);
        Symbol symbol=childOutputSymobls.get(fieldIndex);
        outputSymbolBuilder.add(symbolAllocator.newSymbol(symbol.getName(),symbolAllocator.getTypes().get(symbol)));
      }
      unionOutputSymbols=outputSymbolBuilder.build();
    }
    TupleDescriptor descriptor=relationPlan.getDescriptor();
    checkArgument(descriptor.getVisibleFieldCount() == unionOutputSymbols.size(),"Expected relation to have %s symbols but has %s symbols",descriptor.getVisibleFieldCount(),unionOutputSymbols.size());
    int unionFieldId=0;
    for (    Field field : descriptor.getVisibleFields()) {
      int fieldIndex=descriptor.indexOf(field);
      symbolMapping.put(unionOutputSymbols.get(unionFieldId),childOutputSymobls.get(fieldIndex));
      unionFieldId++;
    }
    sources.add(relationPlan.getRoot());
  }
  PlanNode planNode=new UnionNode(idAllocator.getNextId(),sources.build(),symbolMapping.build());
  if (node.isDistinct()) {
    planNode=distinct(planNode);
  }
  return new RelationPlan(planNode,analysis.getOutputDescriptor(node),planNode.getOutputSymbols());
}
