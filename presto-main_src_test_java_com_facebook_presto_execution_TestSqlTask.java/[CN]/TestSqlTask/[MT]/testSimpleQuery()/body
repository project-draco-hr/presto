{
  SqlTask sqlTask=createInitialTask();
  TaskInfo taskInfo=sqlTask.updateTask(SESSION,PLAN_FRAGMENT,ImmutableList.of(new TaskSource(TABLE_SCAN_NODE_ID,ImmutableSet.of(SPLIT),true)),INITIAL_EMPTY_OUTPUT_BUFFERS.withBuffer("out",new UnpartitionedPagePartitionFunction()).withNoMoreBufferIds());
  assertEquals(taskInfo.getState(),TaskState.RUNNING);
  taskInfo=sqlTask.getTaskInfo();
  assertEquals(taskInfo.getState(),TaskState.RUNNING);
  BufferResult results=sqlTask.getTaskResults("out",0,new DataSize(1,Unit.MEGABYTE)).get();
  assertEquals(results.isBufferClosed(),false);
  assertEquals(results.getPages().size(),1);
  assertEquals(results.getPages().get(0).getPositionCount(),1);
  results=sqlTask.getTaskResults("out",results.getToken() + results.getPages().size(),new DataSize(1,Unit.MEGABYTE)).get();
  assertEquals(results.isBufferClosed(),true);
  assertEquals(results.getPages().size(),0);
  taskInfo=sqlTask.getTaskInfo(taskInfo.getState()).get(1,TimeUnit.SECONDS);
  assertEquals(taskInfo.getState(),TaskState.FINISHED);
  taskInfo=sqlTask.getTaskInfo();
  assertEquals(taskInfo.getState(),TaskState.FINISHED);
}
