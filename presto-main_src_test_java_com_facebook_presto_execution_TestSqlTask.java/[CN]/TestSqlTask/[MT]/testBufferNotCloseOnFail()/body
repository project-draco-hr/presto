{
  SqlTask sqlTask=createInitialTask();
  updateTask(sqlTask,EMPTY_SOURCES,INITIAL_EMPTY_OUTPUT_BUFFERS.withBuffer("out",new UnpartitionedPagePartitionFunction()));
  ListenableFuture<BufferResult> bufferResult=sqlTask.getTaskResults("out",0,new DataSize(1,MEGABYTE));
  assertFalse(bufferResult.isDone());
  TaskState taskState=sqlTask.getTaskInfo().getState();
  sqlTask.failed(new Exception("test"));
  assertEquals(sqlTask.getTaskInfo(taskState).get(200,MILLISECONDS).getState(),TaskState.FAILED);
  try {
    assertTrue(bufferResult.get(200,MILLISECONDS).isBufferClosed());
    fail("expected TimeoutException");
  }
 catch (  TimeoutException expected) {
  }
  assertFalse(sqlTask.getTaskResults("out",0,new DataSize(1,MEGABYTE)).isDone());
}
