{
  Preconditions.checkArgument(!query.getHaving().isPresent(),"not yet implemented: HAVING");
  Preconditions.checkArgument(query.getFrom().size() == 1,"not yet implemented: multiple FROM relations");
  for (  Expression expression : query.getSelect().getSelectItems()) {
    if (expression instanceof AliasedExpression) {
      context.getSymbolAllocator().blacklist(((AliasedExpression)expression).getAlias());
    }
 else     if (expression instanceof QualifiedNameReference) {
      context.getSymbolAllocator().blacklist(((QualifiedNameReference)expression).getName().toString());
    }
  }
  Relation relation=Iterables.getOnlyElement(query.getFrom());
  TupleDescriptor sourceDescriptor=new RelationAnalyzer(metadata,context.getSession()).process(relation,context);
  AnalyzedExpression predicate=null;
  if (query.getWhere().isPresent()) {
    predicate=analyzePredicate(query.getWhere().get(),sourceDescriptor);
  }
  List<AnalyzedExpression> groupBy=analyzeGroupBy(query.getGroupBy(),sourceDescriptor);
  Set<AnalyzedFunction> aggregations=analyzeAggregations(query.getGroupBy(),query.getSelect(),query.getOrderBy(),sourceDescriptor);
  Set<AnalyzedFunction> windowFunctions=analyzeWindowFunctions(query.getSelect(),query.getOrderBy(),sourceDescriptor);
  List<AnalyzedOrdering> orderBy=analyzeOrderBy(metadata,query.getOrderBy(),sourceDescriptor);
  AnalyzedOutput output=analyzeOutput(query.getSelect(),context.getSymbolAllocator(),sourceDescriptor);
  if ((!aggregations.isEmpty()) && (!windowFunctions.isEmpty())) {
    throw new SemanticException(query,"Mixing aggregate and window functions is not yet supported");
  }
  if (query.getSelect().isDistinct()) {
    if (!windowFunctions.isEmpty()) {
      throw new SemanticException(query.getSelect(),"Mixing DISTINCT and window functions is not yet supported");
    }
    analyzeDistinct(output,orderBy);
  }
  Long limit=null;
  if (query.getLimit().isPresent()) {
    limit=Long.parseLong(query.getLimit().get());
  }
  return AnalysisResult.newInstance(context,query.getSelect().isDistinct(),output,predicate,groupBy,aggregations,windowFunctions,limit,orderBy,query);
}
