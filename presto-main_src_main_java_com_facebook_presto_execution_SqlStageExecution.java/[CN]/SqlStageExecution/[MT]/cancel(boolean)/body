{
  Preconditions.checkState(!Thread.holdsLock(this),"Can not cancel while holding a lock on this");
  try (SetThreadName setThreadName=new SetThreadName("Stage-%s",stageId)){
    if (!force) {
      Duration waitTime=new Duration(100,MILLISECONDS);
      for (      RemoteTask remoteTask : tasks.values()) {
        try {
          waitTime=remoteTask.waitForTaskToFinish(waitTime);
        }
 catch (        InterruptedException e) {
          Thread.currentThread().interrupt();
          throw Throwables.propagate(e);
        }
      }
    }
    doUpdateState();
synchronized (this) {
      if (!stageState.get().isDone()) {
        log.debug("Cancelling stage %s",stageId);
        stageState.set(StageState.CANCELED);
      }
    }
    for (    RemoteTask task : tasks.values()) {
      task.cancel();
    }
    for (    StageExecutionNode subStage : subStages.values()) {
      subStage.cancel(force);
    }
  }
 }
