{
  ImmutableMap.Builder<String,PagePartitionFunction> buffers=ImmutableMap.builder();
  List<Node> nodes=nodeSelector.selectRandomNodes(initialHashPartitions);
  for (int taskId=0; taskId < nodes.size(); taskId++) {
    Node node=nodes.get(taskId);
    scheduleTask(taskId,node);
    buffers.put(node.getNodeIdentifier(),new HashPagePartitionFunction(taskId,nodes.size(),0));
  }
synchronized (this) {
    checkState(subStageOutputBuffers == INITIAL_EMPTY_OUTPUT_BUFFERS,"Sub-stage of %s already has buffers set",stageId);
    subStageOutputBuffers=subStageOutputBuffers.withBuffers(buffers.build()).withNoMoreBufferIds();
  }
  updateSubStageOutputBuffers();
}
