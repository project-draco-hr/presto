{
  Preconditions.checkState(!Thread.holdsLock(this),"Can not add exchanges or buffers to tasks while holding a lock on this");
  while (!getState().isDone()) {
    boolean exchangesComplete=exchangesAreComplete();
    boolean outputComplete;
synchronized (this) {
      outputComplete=noMoreOutputIds;
    }
    Multimap<PlanNodeId,URI> exchangeLocations=getExchangeLocations();
    Set<String> outputBuffers=getOutputBuffers();
    for (    RemoteTask task : tasks.values()) {
      task.addExchangeLocations(exchangeLocations,exchangesComplete);
      task.addOutputBuffers(outputBuffers,outputComplete);
    }
    if (exchangesComplete && outputComplete) {
      return;
    }
    waitForMoreExchangesAndBuffers(exchangeLocations,exchangesComplete,outputBuffers,outputComplete);
  }
}
