{
  Preconditions.checkState(!Thread.holdsLock(this),"Can not add exchanges or buffers to tasks while holding a lock on this");
  while (!getState().isDone()) {
    boolean finished=addNewExchangesAndBuffers();
    if (finished || !waitUntilFinished) {
      return;
    }
    waitForNewExchangesOrBuffers();
  }
}
