{
synchronized (this) {
    if (subStageOutputBuffers.getBuffers().containsKey(bufferId)) {
      checkState(subStageOutputBuffers.getBuffers().get(bufferId).equals(pagePartitionFunction),"Stage %s already contains buffer %s, but partition function is %s not %s",stageId,bufferId,subStageOutputBuffers.getBuffers().get(bufferId),pagePartitionFunction);
      return;
    }
    checkState(!subStageOutputBuffers.isNoMoreBufferIds(),"No more buffers already set for sub-stages of %s",stageId);
    subStageOutputBuffers=subStageOutputBuffers.withBuffer(bufferId,pagePartitionFunction);
  }
  updateSubStageOutputBuffers();
}
