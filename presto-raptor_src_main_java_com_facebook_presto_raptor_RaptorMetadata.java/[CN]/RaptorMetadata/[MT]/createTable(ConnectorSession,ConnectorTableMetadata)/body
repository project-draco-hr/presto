{
  Long tableId=dbi.inTransaction(new TransactionCallback<Long>(){
    @Override public Long inTransaction(    final Handle handle,    TransactionStatus status) throws Exception {
      return runIgnoringConstraintViolation(new Callable<Long>(){
        @Override public Long call() throws Exception {
          MetadataDao dao=handle.attach(MetadataDao.class);
          long tableId=dao.insertTable(connectorId,tableMetadata.getTable().getSchemaName(),tableMetadata.getTable().getTableName());
          int ordinalPosition=0;
          for (          ColumnMetadata column : tableMetadata.getColumns()) {
            long columnId=ordinalPosition + 1;
            dao.insertColumn(tableId,columnId,column.getName(),ordinalPosition,column.getType().getTypeSignature().toString());
            ordinalPosition++;
          }
          if (tableMetadata.isSampled()) {
            dao.insertColumn(tableId,ordinalPosition + 1,SAMPLE_WEIGHT_COLUMN_NAME,ordinalPosition,StandardTypes.BIGINT);
          }
          return tableId;
        }
      }
,null);
    }
  }
);
  checkState(tableId != null,"table %s already exists",tableMetadata.getTable());
  RaptorColumnHandle sampleWeightColumnHandle=null;
  if (tableMetadata.isSampled()) {
    sampleWeightColumnHandle=new RaptorColumnHandle(connectorId,SAMPLE_WEIGHT_COLUMN_NAME,tableMetadata.getColumns().size() + 1,BIGINT);
  }
  ColumnMetadata columnMetadata=tableMetadata.getColumns().get(0);
  RaptorColumnHandle countColumnHandle=new RaptorColumnHandle(connectorId,columnMetadata.getName(),columnMetadata.getOrdinalPosition() + 1,columnMetadata.getType());
  return new RaptorTableHandle(connectorId,tableMetadata.getTable().getSchemaName(),tableMetadata.getTable().getTableName(),tableId,countColumnHandle,sampleWeightColumnHandle);
}
