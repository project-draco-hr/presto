{
  PlanWithProperties source;
  PlanWithProperties filteringSource;
  if (distributedJoins && !context.isDownstreamIsDelete()) {
    List<Symbol> sourceSymbols=ImmutableList.of(node.getSourceJoinSymbol());
    List<Symbol> filteringSourceSymbols=ImmutableList.of(node.getFilteringSourceJoinSymbol());
    source=node.getSource().accept(this,context.withPreferredProperties(PreferredProperties.hashPartitioned(sourceSymbols)));
    filteringSource=node.getFilteringSource().accept(this,context.withPreferredProperties(PreferredProperties.any()));
    if (!source.getProperties().isHashPartitionedOn(sourceSymbols)) {
      source=withDerivedProperties(partitionedExchange(idAllocator.getNextId(),source.getNode(),Optional.of(sourceSymbols),node.getSourceHashSymbol()),source.getProperties());
    }
    checkState(!filteringSource.getProperties().isHashPartitionedOn(filteringSourceSymbols) || !filteringSource.getProperties().isNullReplication());
    filteringSource=withDerivedProperties(partitionedExchangeNullReplicate(idAllocator.getNextId(),filteringSource.getNode(),Iterables.getOnlyElement(filteringSourceSymbols),node.getFilteringSourceHashSymbol()),filteringSource.getProperties());
  }
 else {
    source=node.getSource().accept(this,context.withPreferredProperties(PreferredProperties.any()));
    filteringSource=node.getFilteringSource().accept(this,context.withPreferredProperties(PreferredProperties.any()).withHashPartitionedSemiJoinBanned(false));
    if (source.getProperties().isDistributed()) {
      filteringSource=withDerivedProperties(new ExchangeNode(idAllocator.getNextId(),ExchangeNode.Type.REPLICATE,Optional.empty(),Optional.<Symbol>empty(),ImmutableList.of(filteringSource.getNode()),filteringSource.getNode().getOutputSymbols(),ImmutableList.of(filteringSource.getNode().getOutputSymbols())),filteringSource.getProperties());
    }
 else {
      filteringSource=withDerivedProperties(gatheringExchange(idAllocator.getNextId(),filteringSource.getNode()),filteringSource.getProperties());
    }
  }
  return rebaseAndDeriveProperties(node,ImmutableList.of(source,filteringSource));
}
