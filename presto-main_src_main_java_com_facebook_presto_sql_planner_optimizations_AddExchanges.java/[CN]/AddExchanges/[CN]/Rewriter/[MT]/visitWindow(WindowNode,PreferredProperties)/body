{
  PlanWithProperties child=planChild(node,determineChildPreferences(preferred,node.getPartitionBy(),node.getPartitionBy()));
  if (!child.getProperties().isPartitionedOn(node.getPartitionBy())) {
    if (node.getPartitionBy().isEmpty()) {
      child=withDerivedProperties(gatheringExchange(idAllocator.getNextId(),child.getNode()),child.getProperties());
    }
 else {
      child=withDerivedProperties(partitionedExchange(idAllocator.getNextId(),child.getNode(),node.getPartitionBy(),node.getHashSymbol()),child.getProperties());
    }
  }
  return withDerivedProperties(new WindowNode(node.getId(),child.getNode(),node.getPartitionBy(),node.getOrderBy(),node.getOrderings(),node.getFrame(),node.getWindowFunctions(),node.getSignatures(),node.getHashSymbol(),child.getProperties().getMaxGroupingSubset(node.getPartitionBy())),child.getProperties());
}
