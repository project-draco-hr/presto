{
  if (node.getPartitionBy().isEmpty()) {
    PlanWithProperties child=planChild(node,PreferredProperties.unpartitioned());
    if (child.getProperties().isPartitioned()) {
      child=withDerivedProperties(gatheringExchange(idAllocator.getNextId(),child.getNode()),child.getProperties());
    }
    return rebaseAndDeriveProperties(node,child);
  }
  PlanWithProperties child=planChild(node,PreferredProperties.derivePreferences(preferred,ImmutableSet.copyOf(node.getPartitionBy()),grouped(node.getPartitionBy())));
  if (!child.getProperties().isPartitionedOn(node.getPartitionBy())) {
    child=withDerivedProperties(partitionedExchange(idAllocator.getNextId(),child.getNode(),node.getPartitionBy(),node.getHashSymbol()),child.getProperties());
  }
  return rebaseAndDeriveProperties(node,child);
}
