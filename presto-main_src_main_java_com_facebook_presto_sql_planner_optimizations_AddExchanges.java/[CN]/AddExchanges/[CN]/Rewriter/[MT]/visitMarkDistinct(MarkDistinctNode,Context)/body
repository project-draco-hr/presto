{
  PreferredProperties preferredChildProperties=PreferredProperties.derivePreferences(context.getPreferredProperties(),ImmutableSet.copyOf(node.getDistinctSymbols()),Optional.of(node.getDistinctSymbols()),grouped(node.getDistinctSymbols()));
  PlanWithProperties child=node.getSource().accept(this,context.withPreferredProperties(preferredChildProperties));
  if (!child.getProperties().isDistributed() || !child.getProperties().isPartitionedOn(node.getDistinctSymbols())) {
    child=withDerivedProperties(partitionedExchange(idAllocator.getNextId(),child.getNode(),Optional.of(node.getDistinctSymbols()),node.getHashSymbol()),child.getProperties());
  }
  return rebaseAndDeriveProperties(node,child);
}
