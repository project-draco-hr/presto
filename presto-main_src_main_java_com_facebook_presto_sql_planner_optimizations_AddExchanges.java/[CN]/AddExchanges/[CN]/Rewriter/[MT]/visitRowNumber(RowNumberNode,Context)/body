{
  if (node.getPartitionBy().isEmpty()) {
    PlanWithProperties child=planChild(node,context.withPreferredProperties(PreferredProperties.undistributed()));
    if (child.getProperties().isDistributed()) {
      child=withDerivedProperties(gatheringExchange(idAllocator.getNextId(),child.getNode()),child.getProperties());
    }
    return rebaseAndDeriveProperties(node,child);
  }
  PlanWithProperties child=planChild(node,context.withPreferredProperties(PreferredProperties.derivePreferences(context.getPreferredProperties(),ImmutableSet.copyOf(node.getPartitionBy()),grouped(node.getPartitionBy()))));
  if (!child.getProperties().isPartitionedOn(node.getPartitionBy())) {
    child=withDerivedProperties(partitionedExchange(idAllocator.getNextId(),child.getNode(),Optional.of(node.getPartitionBy()),node.getHashSymbol()),child.getProperties());
  }
  return rebaseAndDeriveProperties(node,child);
}
