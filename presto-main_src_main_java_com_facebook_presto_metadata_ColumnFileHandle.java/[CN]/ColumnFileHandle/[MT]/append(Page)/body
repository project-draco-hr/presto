{
  checkNotNull(page,"page is null");
  checkState(!committed.get(),"already committed: %s",shardUuid);
  Block[] blocks=page.getBlocks();
  int[] tupleCount=new int[blocks.length];
  checkState(blocks.length == writers.size(),"Block count does not match writer count (%s vs %s)!",blocks.length,writers.size());
  int i=0;
  for (  BlocksFileWriter writer : writers.values()) {
    Block block=blocks[i];
    writer.append(block);
    tupleCount[i]=block.getPositionCount();
    if (i > 0) {
      checkState(tupleCount[i] == tupleCount[i - 1],"different tuple count (%s vs. %s) for block!",tupleCount[i],tupleCount[i - 1]);
    }
    i++;
  }
  return tupleCount[0];
}
