{
  if (!signature.contains("<") && !signature.contains("(")) {
    return new TypeSignature(signature,new ArrayList<TypeSignature>(),new ArrayList<>());
  }
  String baseName=null;
  List<TypeSignature> parameters=new ArrayList<>();
  List<Object> literalParameters=new ArrayList<>();
  int parameterStart=-1;
  int bracketCount=0;
  boolean inLiteralParameters=false;
  for (int i=0; i < signature.length(); i++) {
    char c=signature.charAt(i);
    if (c == '<') {
      if (bracketCount == 0) {
        checkState(baseName == null,"Expected baseName to be null");
        checkState(parameterStart == -1,"Expected parameter start to be -1");
        baseName=signature.substring(0,i);
        parameterStart=i + 1;
      }
      bracketCount++;
    }
 else     if (c == '>') {
      bracketCount--;
      checkArgument(bracketCount >= 0,"Bad type signature: '%s'",signature);
      if (bracketCount == 0) {
        checkArgument(parameterStart >= 0,"Bad type signature: '%s'",signature);
        parameters.add(parseTypeSignature(signature.substring(parameterStart,i)));
        parameterStart=i + 1;
        if (i == signature.length() - 1) {
          return new TypeSignature(baseName,parameters,literalParameters);
        }
      }
    }
 else     if (c == ',') {
      if (bracketCount == 1 && !inLiteralParameters) {
        checkArgument(parameterStart >= 0,"Bad type signature: '%s'",signature);
        parameters.add(parseTypeSignature(signature.substring(parameterStart,i)));
        parameterStart=i + 1;
      }
 else       if (bracketCount == 0 && inLiteralParameters) {
        checkArgument(parameterStart >= 0,"Bad type signature: '%s'",signature);
        literalParameters.add(parseLiteral(signature.substring(parameterStart,i)));
        parameterStart=i + 1;
      }
    }
 else     if (c == '(') {
      checkArgument(!inLiteralParameters,"Bad type signature: '%s'",signature);
      inLiteralParameters=true;
      if (bracketCount == 0) {
        if (baseName == null) {
          checkState(parameters.isEmpty(),"Expected no parameters");
          checkState(parameterStart == -1,"Expected parameter start to be -1");
          baseName=signature.substring(0,i);
        }
        parameterStart=i + 1;
      }
    }
 else     if (c == ')') {
      checkArgument(inLiteralParameters,"Bad type signature: '%s'",signature);
      inLiteralParameters=false;
      if (bracketCount == 0) {
        checkArgument(i == signature.length() - 1,"Bad type signature: '%s'",signature);
        checkArgument(parameterStart >= 0,"Bad type signature: '%s'",signature);
        literalParameters.add(parseLiteral(signature.substring(parameterStart,i)));
        return new TypeSignature(baseName,parameters,literalParameters);
      }
    }
  }
  throw new IllegalArgumentException(format("Bad type signature: '%s'",signature));
}
