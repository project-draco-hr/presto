{
  List<PlanFragmentSource> splits=this.splits.getAndSet(null);
  checkState(splits != null,"task has already been started");
  TaskInfo taskInfo=this.taskInfo.get();
  QueryFragmentRequest queryFragmentRequest=new QueryFragmentRequest(session,taskInfo.getQueryId(),taskInfo.getStageId(),planFragment,splits,exchangeSources,ImmutableList.copyOf(transform(taskInfo.getOutputBuffers(),PageBufferInfo.bufferIdGetter())));
  Request request=preparePut().setUri(taskInfo.getSelf()).setHeader(HttpHeaders.CONTENT_TYPE,MediaType.APPLICATION_JSON).setBodyGenerator(jsonBodyGenerator(queryFragmentRequestCodec,queryFragmentRequest)).build();
  JsonResponse<TaskInfo> response=httpClient.execute(request,createFullJsonResponseHandler(jsonCodec(TaskInfo.class)));
  checkState(response.getStatusCode() == 201,"Expected response code from %s to be 201, but was %s: %s",request.getUri(),response.getStatusCode(),response.getStatusMessage());
  String location=response.getHeader("Location");
  checkState(location != null);
  this.taskInfo.set(response.getValue());
}
