{
  String catalog=trimEmptyToNull(servletRequest.getHeader(PRESTO_CATALOG));
  String schema=trimEmptyToNull(servletRequest.getHeader(PRESTO_SCHEMA));
  assertRequest((catalog != null) || (schema == null),"Schema is set but catalog is not");
  String user=trimEmptyToNull(servletRequest.getHeader(PRESTO_USER));
  assertRequest(user != null,"User must be set");
  Principal principal=servletRequest.getUserPrincipal();
  try {
    accessControl.checkCanSetUser(principal,user);
  }
 catch (  AccessDeniedException e) {
    throw new WebApplicationException(e.getMessage(),Status.FORBIDDEN);
  }
  Identity identity=new Identity(user,Optional.ofNullable(principal));
  SessionBuilder sessionBuilder=Session.builder(sessionPropertyManager).setQueryId(queryId).setIdentity(identity).setSource(servletRequest.getHeader(PRESTO_SOURCE)).setCatalog(catalog).setSchema(schema).setRemoteUserAddress(servletRequest.getRemoteAddr()).setUserAgent(servletRequest.getHeader(USER_AGENT));
  String transactionId=trimEmptyToNull(servletRequest.getHeader(PRESTO_TRANSACTION_ID));
  if (transactionId != null) {
    sessionBuilder.setTransactionId(getTransactionId(transactionId));
  }
  String timeZoneId=servletRequest.getHeader(PRESTO_TIME_ZONE);
  if (timeZoneId != null) {
    sessionBuilder.setTimeZoneKey(getTimeZoneKey(timeZoneId));
  }
  String language=servletRequest.getHeader(PRESTO_LANGUAGE);
  if (language != null) {
    sessionBuilder.setLocale(Locale.forLanguageTag(language));
  }
  Multimap<String,Entry<String,String>> sessionPropertiesByCatalog=HashMultimap.create();
  for (  String sessionHeader : splitSessionHeader(servletRequest.getHeaders(PRESTO_SESSION))) {
    parseSessionHeader(sessionHeader,sessionPropertiesByCatalog,sessionPropertyManager);
  }
  try {
    for (    Entry<String,Entry<String,String>> property : sessionPropertiesByCatalog.entries()) {
      String catalogName=property.getKey();
      String propertyName=property.getValue().getKey();
      if (catalogName == null) {
        accessControl.checkCanSetSystemSessionProperty(identity,propertyName);
      }
 else {
        accessControl.checkCanSetCatalogSessionProperty(identity,catalogName,propertyName);
      }
    }
  }
 catch (  AccessDeniedException e) {
    throw new WebApplicationException(e.getMessage(),Status.BAD_REQUEST);
  }
  sessionBuilder.setSystemProperties(toMap(sessionPropertiesByCatalog.get(null)));
  for (  Entry<String,Collection<Entry<String,String>>> entry : sessionPropertiesByCatalog.asMap().entrySet()) {
    if (entry.getKey() != null) {
      sessionBuilder.setCatalogProperties(entry.getKey(),toMap(entry.getValue()));
    }
  }
  return sessionBuilder.build();
}
