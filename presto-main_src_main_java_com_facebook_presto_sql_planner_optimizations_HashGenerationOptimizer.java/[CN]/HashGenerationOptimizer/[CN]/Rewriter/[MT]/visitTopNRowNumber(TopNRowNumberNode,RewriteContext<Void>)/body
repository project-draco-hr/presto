{
  PlanNode rewrittenSource=context.rewrite(node.getSource(),null);
  if (rewrittenSource == node.getSource() && node.getPartitionBy().isEmpty()) {
    return node;
  }
  if (node.getPartitionBy().isEmpty()) {
    return new TopNRowNumberNode(idAllocator.getNextId(),rewrittenSource,node.getPartitionBy(),node.getOrderBy(),node.getOrderings(),node.getRowNumberSymbol(),node.getMaxRowCountPerPartition(),node.isPartial(),node.getHashSymbol());
  }
  Symbol hashSymbol=symbolAllocator.newHashSymbol();
  PlanNode hashProjectNode=getHashProjectNode(idAllocator,rewrittenSource,hashSymbol,node.getPartitionBy());
  return new TopNRowNumberNode(idAllocator.getNextId(),hashProjectNode,node.getPartitionBy(),node.getOrderBy(),node.getOrderings(),node.getRowNumberSymbol(),node.getMaxRowCountPerPartition(),node.isPartial(),Optional.of(hashSymbol));
}
