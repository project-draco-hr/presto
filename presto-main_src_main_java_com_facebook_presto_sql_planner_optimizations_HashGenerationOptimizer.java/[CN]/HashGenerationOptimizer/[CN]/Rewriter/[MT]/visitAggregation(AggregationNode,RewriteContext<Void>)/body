{
  PlanNode rewrittenSource=context.rewrite(node.getSource(),null);
  if (rewrittenSource == node.getSource() && node.getGroupBy().isEmpty()) {
    return node;
  }
  if (node.getGroupBy().isEmpty() || canSkipHashGeneration(node)) {
    return new AggregationNode(idAllocator.getNextId(),rewrittenSource,node.getGroupBy(),node.getAggregations(),node.getFunctions(),node.getMasks(),node.getStep(),node.getSampleWeight(),node.getConfidence(),Optional.empty());
  }
  Symbol hashSymbol=symbolAllocator.newHashSymbol();
  PlanNode hashProjectNode=getHashProjectNode(idAllocator,rewrittenSource,hashSymbol,node.getGroupBy());
  return new AggregationNode(idAllocator.getNextId(),hashProjectNode,node.getGroupBy(),node.getAggregations(),node.getFunctions(),node.getMasks(),node.getStep(),node.getSampleWeight(),node.getConfidence(),Optional.of(hashSymbol));
}
