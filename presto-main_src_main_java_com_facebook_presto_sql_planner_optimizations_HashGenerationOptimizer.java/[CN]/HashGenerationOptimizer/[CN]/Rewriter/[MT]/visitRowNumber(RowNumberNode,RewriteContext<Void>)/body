{
  PlanNode rewrittenSource=context.rewrite(node.getSource(),null);
  if (rewrittenSource == node.getSource() && node.getPartitionBy().isEmpty()) {
    return node;
  }
  if (!node.getPartitionBy().isEmpty()) {
    Symbol hashSymbol=symbolAllocator.newHashSymbol();
    PlanNode hashProjectNode=getHashProjectNode(idAllocator,rewrittenSource,hashSymbol,node.getPartitionBy());
    return new RowNumberNode(idAllocator.getNextId(),hashProjectNode,node.getPartitionBy(),node.getRowNumberSymbol(),node.getMaxRowCountPerPartition(),Optional.of(hashSymbol));
  }
  return new RowNumberNode(idAllocator.getNextId(),rewrittenSource,node.getPartitionBy(),node.getRowNumberSymbol(),node.getMaxRowCountPerPartition(),node.getHashSymbol());
}
