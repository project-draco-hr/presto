{
  PlanNode rewrittenSource=planRewriter.rewrite(node.getSource(),null);
  if (rewrittenSource == node.getSource() && node.getPartitionBy().isEmpty()) {
    return node;
  }
  if (node.getPartitionBy().isEmpty()) {
    return new WindowNode(idAllocator.getNextId(),rewrittenSource,node.getPartitionBy(),node.getOrderBy(),node.getOrderings(),node.getWindowFunctions(),node.getSignatures(),Optional.<Symbol>absent());
  }
  Symbol hashSymbol=symbolAllocator.newHashSymbol();
  PlanNode hashProjectNode=getHashProjectNode(idAllocator,rewrittenSource,hashSymbol,node.getPartitionBy());
  return new WindowNode(idAllocator.getNextId(),hashProjectNode,node.getPartitionBy(),node.getOrderBy(),node.getOrderings(),node.getWindowFunctions(),node.getSignatures(),Optional.of(hashSymbol));
}
