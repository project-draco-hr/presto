{
  Set<UUID> shardUuids=shard.getShardUuids();
  Collection<String> nodeIds=shard.getNodeIdentifiers();
  List<HostAddress> addresses=getAddressesForNodes(nodesById,nodeIds);
  if (shard.getBucketNumber().isPresent()) {
    int bucketNumber=shard.getBucketNumber().getAsInt();
    if (addresses.isEmpty()) {
      throw new PrestoException(NO_NODES_AVAILABLE,"Reassignment not yet implemented");
    }
    return new RaptorSplit(connectorId,shardUuids,bucketNumber,addresses,effectivePredicate,transactionId);
  }
  verify(shardUuids.size() == 1,"wrong shard count for non-bucketed table: %s",shardUuids.size());
  UUID shardId=shardUuids.iterator().next();
  if (addresses.isEmpty()) {
    if (!backupAvailable) {
      throw new PrestoException(RAPTOR_NO_HOST_FOR_SHARD,format("No host for shard %s found: %s",shardId,nodeIds));
    }
    Set<Node> availableNodes=nodeSupplier.getWorkerNodes();
    if (availableNodes.isEmpty()) {
      throw new PrestoException(NO_NODES_AVAILABLE,"No nodes available to run query");
    }
    Node node=selectRandom(availableNodes);
    shardManager.assignShard(tableId,shardId,node.getNodeIdentifier());
    addresses=ImmutableList.of(node.getHostAndPort());
  }
  return new RaptorSplit(connectorId,shardId,addresses,effectivePredicate,transactionId);
}
