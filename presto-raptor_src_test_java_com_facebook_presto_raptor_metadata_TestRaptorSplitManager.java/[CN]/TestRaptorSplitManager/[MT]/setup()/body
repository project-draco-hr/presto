{
  TypeRegistry typeRegistry=new TypeRegistry();
  DBI dbi=new DBI("jdbc:h2:mem:test" + System.nanoTime());
  dbi.registerMapper(new TableColumn.Mapper(typeRegistry));
  dummyHandle=dbi.open();
  dataDir=Files.createTempDir();
  shardManager=new DatabaseShardManager(dbi);
  InMemoryNodeManager nodeManager=new InMemoryNodeManager();
  StorageService storageService=new FileStorageService(dataDir,Optional.empty());
  StorageService storageServiceWithBackup=new FileStorageService(dataDir,Optional.of(Files.createTempDir()));
  ShardRecoveryManager recoveryManager=new ShardRecoveryManager(storageServiceWithBackup,new InMemoryNodeManager(),shardManager,new Duration(5,TimeUnit.MINUTES),10);
  StorageManager storageManager=new OrcStorageManager(storageService,ORC_MAX_MERGE_DISTANCE,recoveryManager,SHARD_RECOVERY_TIMEOUT,ROWS_PER_SHARD,MAX_BUFFER_SIZE);
  storageManagerWithBackup=new OrcStorageManager(storageServiceWithBackup,ORC_MAX_MERGE_DISTANCE,recoveryManager,SHARD_RECOVERY_TIMEOUT,ROWS_PER_SHARD,MAX_BUFFER_SIZE);
  String nodeName=UUID.randomUUID().toString();
  nodeManager.addNode("raptor",new PrestoNode(nodeName,new URI("http://127.0.0.1/"),NodeVersion.UNKNOWN));
  RaptorConnectorId connectorId=new RaptorConnectorId("raptor");
  RaptorMetadata metadata=new RaptorMetadata(connectorId,dbi,shardManager);
  tableHandle=metadata.createTable(SESSION,TEST_TABLE);
  List<ShardNode> shardNodes=ImmutableList.<ShardNode>builder().add(new ShardNode(UUID.randomUUID(),nodeName)).add(new ShardNode(UUID.randomUUID(),nodeName)).add(new ShardNode(UUID.randomUUID(),nodeName)).add(new ShardNode(UUID.randomUUID(),nodeName)).build();
  long tableId=checkType(tableHandle,RaptorTableHandle.class,"tableHandle").getTableId();
  shardManager.commitTable(tableId,shardNodes,Optional.empty());
  raptorSplitManager=new RaptorSplitManager(connectorId,nodeManager,shardManager,storageManager);
}
