{
  Preconditions.checkState(!Thread.holdsLock(this),"Can not start while holding a lock on this");
synchronized (this) {
    Preconditions.checkState(queryState.compareAndSet(QueryState.QUEUED,QueryState.PLANNING),"Stage has already been started");
  }
  try {
    queryStats.recordAnalysisStart();
    SubPlan subplan=analyseQuery();
    planDistribution(subplan);
synchronized (this) {
      Preconditions.checkState(queryState.compareAndSet(QueryState.PLANNING,QueryState.STARTING),"Expected query to be in state %s",QueryState.PLANNING);
    }
    startStage(outputStage.get());
  }
 catch (  Exception e) {
synchronized (this) {
      failureCauses.add(e);
      queryStats.recordEnd();
      queryState.set(QueryState.FAILED);
      eventClient.post(queryEventFactory.createCompletionEvent(getQueryInfo()));
    }
    cancel();
  }
}
