{
  if (stateMachine.isDone()) {
    return;
  }
  if (outputStageState.isDone()) {
    if (outputStageState.isFailure()) {
      stateMachine.transitionToFailed(failureCause(outputStage.get().getStageInfo()));
    }
 else     if (outputStageState == StageState.CANCELED) {
      stateMachine.transitionToFailed(new PrestoException(USER_CANCELED,"Query was canceled"));
    }
 else {
      stateMachine.transitionToFinished();
    }
  }
 else   if (stateMachine.getQueryState() == QueryState.STARTING) {
    if (!outputStage.get().getStageInfo().getTasks().isEmpty()) {
      stateMachine.transitionToRunning();
    }
  }
}
