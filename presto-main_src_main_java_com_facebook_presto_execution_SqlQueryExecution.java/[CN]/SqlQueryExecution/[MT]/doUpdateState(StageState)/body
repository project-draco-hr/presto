{
  if (stateMachine.isDone()) {
    return;
  }
  StageInfo outputStageInfo=outputStage.get().getStageInfo();
  if (outputStageState.isDone()) {
    if (outputStageState.isFailure()) {
      stateMachine.transitionToFailed(outputStageInfo.getFailureCause().toException());
    }
 else     if (outputStageState == StageState.CANCELED) {
      stateMachine.transitionToFailed(new PrestoException(USER_CANCELED,"Query was canceled"));
    }
 else {
      stateMachine.transitionToFinished();
    }
  }
 else   if (stateMachine.getQueryState() == QueryState.STARTING) {
    if (!outputStageInfo.getTasks().isEmpty()) {
      stateMachine.transitionToRunning();
    }
  }
}
