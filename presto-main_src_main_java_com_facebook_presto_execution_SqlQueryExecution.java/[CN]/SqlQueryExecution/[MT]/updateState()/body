{
  Preconditions.checkState(!Thread.holdsLock(this),"Can not update while holding a lock on this");
  SqlStageExecution outputStage=this.outputStage.get();
  if (outputStage == null) {
    return;
  }
  outputStage.updateState();
synchronized (this) {
    if (queryState.get().isDone()) {
      return;
    }
    StageInfo outputStageInfo=outputStage.getStageInfo();
    StageState outputStageState=outputStageInfo.getState();
    if (outputStageState.isDone()) {
      if (outputStageState == StageState.FAILED) {
        log.debug("Transition query %s to FAILED: output stage FAILED",queryId);
        this.queryState.set(QueryState.FAILED);
      }
 else       if (outputStageState == StageState.CANCELED) {
        log.debug("Transition query %s to CANCELED: output stage CANCELED",queryId);
        this.queryState.set(QueryState.CANCELED);
      }
 else {
        log.debug("Transition query %s to FINISHED: output stage FINISHED",queryId);
        this.queryState.set(QueryState.FINISHED);
      }
      queryStats.recordEnd();
      queryMonitor.completionEvent(getQueryInfo());
    }
 else     if (queryState.get() == QueryState.STARTING) {
      if (outputStageState == StageState.RUNNING) {
        this.queryState.set(QueryState.RUNNING);
      }
      if (any(transform(getAllStages(outputStage.getStageInfo()),stageStateGetter()),isStageRunningOrDone())) {
        queryStats.recordExecutionStart();
      }
    }
  }
}
