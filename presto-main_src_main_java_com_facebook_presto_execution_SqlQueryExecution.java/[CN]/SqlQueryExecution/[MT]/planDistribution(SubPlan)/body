{
  long distributedPlanningStart=System.nanoTime();
  DistributedExecutionPlanner distributedPlanner=new DistributedExecutionPlanner(splitManager,shardManager);
  StageExecutionPlan outputStageExecutionPlan=distributedPlanner.plan(subplan);
  if (stateMachine.isDone()) {
    return;
  }
  stateMachine.setOutputFieldNames(outputStageExecutionPlan.getFieldNames());
  SqlStageExecution outputStage=new SqlStageExecution(stateMachine.getQueryId(),locationFactory,outputStageExecutionPlan,nodeScheduler,remoteTaskFactory,stateMachine.getSession(),maxPendingSplitsPerNode,initialHashPartitions,queryExecutor);
  this.outputStage.set(outputStage);
  outputStage.addStateChangeListener(new StateChangeListener<StageInfo>(){
    @Override public void stateChanged(    StageInfo stageInfo){
      doUpdateState(stageInfo);
    }
  }
);
  stateMachine.recordDistributedPlanningTime(distributedPlanningStart);
  doUpdateState(outputStage.getStageInfo());
}
