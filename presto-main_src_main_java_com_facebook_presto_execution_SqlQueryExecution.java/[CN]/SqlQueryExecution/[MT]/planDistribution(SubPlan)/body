{
  long distributedPlanningStart=System.nanoTime();
  DistributedExecutionPlanner distributedPlanner=new DistributedExecutionPlanner(splitManager,stateMachine.getSession(),shardManager);
  StageExecutionPlan outputStageExecutionPlan=distributedPlanner.plan(subplan);
  if (stateMachine.isDone()) {
    return;
  }
  stateMachine.setOutputFieldNames(outputStageExecutionPlan.getFieldNames());
  SqlStageExecution outputStage=new SqlStageExecution(stateMachine.getQueryId(),locationFactory,outputStageExecutionPlan,nodeManager,remoteTaskFactory,stateMachine.getSession(),maxPendingSplitsPerNode,queryExecutor);
  this.outputStage.set(outputStage);
  stateMachine.getStats().recordDistributedPlanningTime(distributedPlanningStart);
}
