{
  Preconditions.checkState(!Thread.holdsLock(this),"Can not cancel while holding a lock on this");
synchronized (this) {
    if (!queryState.get().isDone()) {
      failureCauses.add(cause);
      queryStats.recordEnd();
      queryState.set(QueryState.FAILED);
      queryMonitor.completionEvent(getQueryInfo());
      log.debug("Failing query %s",queryId);
    }
  }
  SqlStageExecution stageExecution=outputStage.get();
  if (stageExecution != null) {
    stageExecution.cancel();
  }
}
