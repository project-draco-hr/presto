{
  Preconditions.checkState(!Thread.holdsLock(this),"Can not cancel while holding a lock on this");
synchronized (this) {
    if (!queryState.get().isDone()) {
      queryStats.recordEnd();
      queryState.set(QueryState.CANCELED);
      queryMonitor.completionEvent(getQueryInfo());
      log.debug("Cancelling query %s",queryId);
    }
  }
  StageExecution stageExecution=outputStage.get();
  if (stageExecution != null) {
    stageExecution.cancel();
  }
}
