{
  Preconditions.checkState(!Thread.holdsLock(this),"Can not cancel while holding a lock on this");
synchronized (this) {
    if (!queryState.get().isDone()) {
      queryStats.recordEnd();
      queryState.set(QueryState.CANCELED);
      eventClient.post(queryEventFactory.createCompletionEvent(getQueryInfo()));
    }
  }
  StageExecution stageExecution=outputStage.get();
  if (stageExecution != null) {
    stageExecution.cancel();
  }
}
