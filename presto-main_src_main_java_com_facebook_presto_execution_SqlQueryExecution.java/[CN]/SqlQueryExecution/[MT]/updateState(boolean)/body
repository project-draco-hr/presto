{
  if (!forceRefresh) {
synchronized (this) {
      if (queryExecutionState.isDone()) {
        return;
      }
    }
  }
  SqlStageExecution outputStage=this.outputStage.get();
  if (outputStage == null) {
    return;
  }
  outputStage.updateState();
  if (!queryExecutionState.isDone()) {
    StageInfo outputStageInfo=outputStage.getStageInfo();
    StageState outputStageState=outputStageInfo.getState();
    if (outputStageState.isDone()) {
      if (outputStageState == StageState.FAILED) {
        log.debug("Transition query %s to FAILED: output stage FAILED",getQueryId(queryInfo));
        queryExecutionState.toState(QueryState.FAILED);
      }
 else       if (outputStageState == StageState.CANCELED) {
        log.debug("Transition query %s to CANCELED: output stage CANCELED",getQueryId(queryInfo));
        queryExecutionState.toState(QueryState.CANCELED);
      }
 else {
        log.debug("Transition query %s to FINISHED: output stage FINISHED",getQueryId(queryInfo));
        queryExecutionState.toState(QueryState.FINISHED);
      }
      getQueryStats(queryInfo).recordEnd();
      queryMonitor.completionEvent(getQueryInfo());
    }
 else     if (queryExecutionState.getQueryState() == QueryState.STARTING) {
      if (outputStageState == StageState.RUNNING) {
        queryExecutionState.transitionToRunningState();
      }
      if (any(transform(getAllStages(outputStage.getStageInfo()),stageStateGetter()),isStageRunningOrDone())) {
        getQueryStats(queryInfo).recordExecutionStart();
      }
    }
  }
}
