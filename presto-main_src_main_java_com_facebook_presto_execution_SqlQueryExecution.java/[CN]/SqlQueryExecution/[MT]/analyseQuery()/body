{
  Preconditions.checkState(!Thread.holdsLock(this),"Can not analyse while holding a lock on this");
  long analysisStart=System.nanoTime();
  Statement statement=SqlParser.createStatement(sql);
  Analyzer analyzer=new Analyzer(session,metadata);
  AnalysisResult analysis=analyzer.analyze(statement);
  LogicalPlanner logicalPlanner=new LogicalPlanner();
  PlanNode plan=logicalPlanner.plan((Query)statement,analysis);
  SubPlan subplan=new DistributedLogicalPlanner(metadata).createSubplans(plan,analysis.getSymbolAllocator(),false);
  queryStats.recordAnalysisTime(analysisStart);
  return subplan;
}
