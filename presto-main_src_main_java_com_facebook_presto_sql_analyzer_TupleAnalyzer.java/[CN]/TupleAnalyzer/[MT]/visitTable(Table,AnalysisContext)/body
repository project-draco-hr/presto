{
  if (!table.getName().getPrefix().isPresent()) {
    String name=table.getName().getSuffix();
    Query query=context.getNamedQuery(name);
    if (query != null) {
      analysis.registerNamedQuery(table,query);
      TupleDescriptor queryDescriptor=analysis.getOutputDescriptor(query);
      ImmutableList.Builder<Field> fields=ImmutableList.builder();
      for (      Field field : queryDescriptor.getAllFields()) {
        fields.add(Field.newQualified(QualifiedName.of(name),field.getName(),field.getType(),false));
      }
      TupleDescriptor descriptor=new TupleDescriptor(fields.build());
      analysis.setOutputDescriptor(table,descriptor);
      return descriptor;
    }
  }
  QualifiedTableName name=MetadataUtil.createQualifiedTableName(session,table.getName());
  Optional<String> view=metadata.getView(session,name);
  if (view.isPresent()) {
    Query query=parseView(view.get(),name);
    analysis.registerNamedQuery(table,query);
    TupleDescriptor descriptor=analyzeView(query,name);
    analysis.setOutputDescriptor(table,descriptor);
    return descriptor;
  }
  Optional<TableHandle> tableHandle=metadata.getTableHandle(session,name);
  if (!tableHandle.isPresent()) {
    if (!metadata.getCatalogNames().containsKey(name.getCatalogName())) {
      throw new SemanticException(MISSING_CATALOG,table,"Catalog %s does not exist",name.getCatalogName());
    }
    if (!metadata.listSchemaNames(session,name.getCatalogName()).contains(name.getSchemaName())) {
      throw new SemanticException(MISSING_SCHEMA,table,"Schema %s does not exist",name.getSchemaName());
    }
    if (table.getName().getSuffix().equalsIgnoreCase("DUAL")) {
      throw new SemanticException(MISSING_TABLE,table,"DUAL table is no longer supported. Please use VALUES or FROM-less queries instead");
    }
    throw new SemanticException(MISSING_TABLE,table,"Table %s does not exist",name);
  }
  TableMetadata tableMetadata=metadata.getTableMetadata(tableHandle.get());
  ImmutableList.Builder<Field> fields=ImmutableList.builder();
  for (  ColumnMetadata column : tableMetadata.getColumns()) {
    Field field=Field.newQualified(table.getName(),Optional.of(column.getName()),column.getType(),column.isHidden());
    fields.add(field);
    Optional<ColumnHandle> columnHandle=metadata.getColumnHandle(tableHandle.get(),column.getName());
    checkArgument(columnHandle.isPresent(),"Unknown field %s",field);
    analysis.setColumn(field,columnHandle.get());
  }
  analysis.registerTable(table,tableHandle.get());
  TupleDescriptor descriptor=new TupleDescriptor(fields.build());
  analysis.setOutputDescriptor(table,descriptor);
  return descriptor;
}
