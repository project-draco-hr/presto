{
  try {
    Identity identity;
    AccessControl viewAccessControl;
    if (owner.isPresent()) {
      identity=new Identity(owner.get(),Optional.empty());
      viewAccessControl=new ViewAccessControl(accessControl);
    }
 else {
      identity=session.getIdentity();
      viewAccessControl=accessControl;
    }
    Session viewSession=Session.builder(metadata.getSessionPropertyManager()).setIdentity(identity).setSource(session.getSource().orElse(null)).setCatalog(catalog).setSchema(schema).setTimeZoneKey(session.getTimeZoneKey()).setLocale(session.getLocale()).setRemoteUserAddress(session.getRemoteUserAddress().orElse(null)).setUserAgent(session.getUserAgent().orElse(null)).setStartTime(session.getStartTime()).build();
    StatementAnalyzer analyzer=new StatementAnalyzer(analysis,metadata,sqlParser,viewAccessControl,viewSession,experimentalSyntaxEnabled,Optional.empty());
    return analyzer.process(query,new AnalysisContext());
  }
 catch (  RuntimeException e) {
    throw new SemanticException(VIEW_ANALYSIS_ERROR,node,"Failed analyzing stored view '%s': %s",name,e.getMessage());
  }
}
