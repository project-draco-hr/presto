{
  if (relation.getType() == SampledRelation.Type.SYSTEM) {
    throw new SemanticException(NOT_SUPPORTED,relation,"TABLESAMPLE SYSTEM not yet implemented");
  }
  ExpressionInterpreter samplePercentageEval=ExpressionInterpreter.expressionOptimizer(new SymbolResolver(){
    @Override public Object getValue(    Symbol symbol){
      throw new SemanticException(NON_NUMERIC_SAMPLE_PERCENTAGE,relation.getSamplePercentage(),"Sample percentage cannot contain column references");
    }
  }
,metadata,session);
  Object samplePercentageObject=samplePercentageEval.process(relation.getSamplePercentage(),null);
  if (!(samplePercentageObject instanceof Number)) {
    throw new SemanticException(SemanticErrorCode.NON_NUMERIC_SAMPLE_PERCENTAGE,relation.getSamplePercentage(),"Sample percentage should evaluate to a numeric expression");
  }
  double samplePercentageValue=((Number)samplePercentageObject).doubleValue();
  if (samplePercentageValue < 0.0 || samplePercentageValue > 100.0) {
    throw new SemanticException(SemanticErrorCode.SAMPLE_PERCENTAGE_OUT_OF_RANGE,relation.getSamplePercentage(),"Sample percentage must be between 0 and 100");
  }
  TupleDescriptor descriptor=process(relation.getRelation(),context);
  analysis.setOutputDescriptor(relation,descriptor);
  analysis.setSampleRatio(relation,samplePercentageValue / 100);
  return descriptor;
}
