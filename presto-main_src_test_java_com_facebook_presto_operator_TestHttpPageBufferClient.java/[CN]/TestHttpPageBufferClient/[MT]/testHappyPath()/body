{
  Page expectedPage=new Page(100);
  DataSize expectedMaxSize=new DataSize(11,Unit.MEGABYTE);
  MockExchangeRequestProcessor processor=new MockExchangeRequestProcessor(expectedMaxSize);
  CyclicBarrier requestComplete=new CyclicBarrier(2);
  TestingClientCallback callback=new TestingClientCallback(requestComplete);
  URI location=URI.create("http://localhost:8080");
  HttpPageBufferClient client=new HttpPageBufferClient(new TestingHttpClient(processor,executor),expectedMaxSize,location,callback,createTestingBlockEncodingManager(),executor);
  assertStatus(client,location,"queued",0,0,0,"queued");
  processor.addPage(location,expectedPage);
  callback.resetStats();
  client.scheduleRequest();
  requestComplete.await(1,TimeUnit.SECONDS);
  assertEquals(callback.getPages().size(),1);
  assertPageEquals(expectedPage,callback.getPages().get(0));
  assertEquals(callback.getCompletedRequests(),1);
  assertEquals(callback.getFinishedBuffers(),0);
  assertStatus(client,location,"queued",1,1,1,"queued");
  callback.resetStats();
  client.scheduleRequest();
  requestComplete.await(1,TimeUnit.SECONDS);
  assertEquals(callback.getPages().size(),0);
  assertEquals(callback.getCompletedRequests(),1);
  assertEquals(callback.getFinishedBuffers(),0);
  assertStatus(client,location,"queued",1,2,2,"queued");
  processor.addPage(location,expectedPage);
  processor.addPage(location,expectedPage);
  callback.resetStats();
  client.scheduleRequest();
  requestComplete.await(1,TimeUnit.SECONDS);
  assertEquals(callback.getPages().size(),2);
  assertPageEquals(expectedPage,callback.getPages().get(0));
  assertPageEquals(expectedPage,callback.getPages().get(1));
  assertEquals(callback.getCompletedRequests(),1);
  assertEquals(callback.getFinishedBuffers(),0);
  assertEquals(callback.getFailedBuffers(),0);
  callback.resetStats();
  assertStatus(client,location,"queued",3,3,3,"queued");
  callback.resetStats();
  processor.setComplete(location);
  client.scheduleRequest();
  requestComplete.await(1,TimeUnit.SECONDS);
  assertEquals(callback.getPages().size(),0);
  assertEquals(callback.getCompletedRequests(),0);
  assertEquals(callback.getFinishedBuffers(),1);
  assertEquals(callback.getFailedBuffers(),0);
  assertStatus(client,location,"closed",3,4,4,"queued");
}
