{
  if (sourceIterator.hasNext()) {
    SplitAssignments sourceAssignment=sourceIterator.next();
    Map<PlanNodeId,? extends Split> sourceSplits=sourceAssignment.getSplits();
    checkState(sourceSplits.size() == 1,"Can only augment single table splits");
    Map.Entry<PlanNodeId,? extends Split> split=Iterables.getOnlyElement(sourceSplits.entrySet());
    WritingSplit writingSplit=new WritingSplit(shardManager.allocateShard(node.getTableHandle()));
    String partition="unpartitioned";
    boolean lastSplit=false;
    if (split.getValue() instanceof PartitionedSplit) {
      PartitionedSplit partitionedSplit=(PartitionedSplit)split.getValue();
      partition=partitionedSplit.getPartition();
      lastSplit=partitionedSplit.isLastSplit();
    }
    addPartitionShard(partition,lastSplit,writingSplit.getShardId());
    ImmutableMap.Builder<PlanNodeId,Split> builder=ImmutableMap.builder();
    builder.putAll(sourceSplits);
    builder.put(node.getId(),writingSplit);
    Map<PlanNodeId,? extends Split> newSplits=builder.build();
    shardsInFlight.incrementAndGet();
    return new SplitAssignments(newSplits,sourceAssignment.getNodes());
  }
 else {
    for (    String partition : openPartitions.keySet()) {
      addPartitionShard(partition,true,null);
    }
    checkState(openPartitions.size() == 0,"Still open partitions: %s",openPartitions);
    return endOfData();
  }
}
