{
  Set<Long> partitionSplits=openPartitions.get(partition);
  ImmutableSet.Builder<Long> builder=ImmutableSet.builder();
  if (partitionSplits != null) {
    builder.addAll(partitionSplits);
  }
  if (shardId != null) {
    builder.add(shardId);
  }
  Set<Long> shardIds=builder.build();
  checkState(shardIds.size() > 0,"Never saw a split for partition %s",partition);
  if (lastSplit) {
    checkState(null == finishedPartitions.put(partition,shardIds),"Partition %s finished multiple times",partition);
    openPartitions.remove(partition);
    log.info("Partition %s is now fully scheduled, seen %d splits, Partitions stats: FLIGHT: %d, READY: %d, COMMIT: %d)",partition,shardIds.size(),openPartitions.size(),finishedPartitions.size(),partitionsDone.size());
  }
 else {
    openPartitions.put(partition,shardIds);
  }
}
