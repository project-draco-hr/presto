{
  Set<Long> partitionSplits=openPartitions.get(partition);
  ImmutableSet.Builder<Long> builder=ImmutableSet.builder();
  if (partitionSplits != null) {
    builder.addAll(partitionSplits);
  }
  if (shardId != null) {
    builder.add(shardId);
  }
 else {
    checkState(lastSplit,"shardId == null and lastSplit unset!");
  }
  Set<Long> shardIds=builder.build();
  checkState(shardIds.size() > 0,"Never saw a split for partition %s",partition);
  if (lastSplit) {
    checkState(null == finishedPartitions.put(partition,shardIds),"Partition %s finished multiple times",partition);
    openPartitions.remove(partition);
  }
 else {
    openPartitions.put(partition,shardIds);
  }
}
