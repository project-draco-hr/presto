{
  List<Type> types=new ArrayList<>(groupByHash.getTypes());
  for (  Aggregator aggregator : aggregators) {
    types.add(aggregator.getType());
  }
  final PageBuilder pageBuilder=new PageBuilder(types);
  return new AbstractIterator<Page>(){
    private final ObjectIterator<Entry> pagePositionToGroup=groupByHash.getPagePositionToGroupId().long2IntEntrySet().fastIterator();
    @Override protected Page computeNext(){
      if (!pagePositionToGroup.hasNext()) {
        return endOfData();
      }
      pageBuilder.reset();
      List<Type> types=groupByHash.getTypes();
      BlockBuilder[] groupByBlockBuilders=new BlockBuilder[types.size()];
      for (int i=0; i < types.size(); i++) {
        groupByBlockBuilders[i]=pageBuilder.getBlockBuilder(i);
      }
      while (!pageBuilder.isFull() && pagePositionToGroup.hasNext()) {
        Entry next=pagePositionToGroup.next();
        long pagePosition=next.getLongKey();
        int groupId=next.getIntValue();
        groupByHash.appendValuesTo(pagePosition,groupByBlockBuilders);
        for (int i=0; i < aggregators.size(); i++) {
          Aggregator aggregator=aggregators.get(i);
          BlockBuilder output=pageBuilder.getBlockBuilder(types.size() + i);
          aggregator.evaluate(groupId,output);
        }
      }
      Page page=pageBuilder.build();
      return page;
    }
  }
;
}
