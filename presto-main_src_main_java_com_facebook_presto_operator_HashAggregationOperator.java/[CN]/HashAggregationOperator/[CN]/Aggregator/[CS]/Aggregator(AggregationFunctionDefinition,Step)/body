{
  InternalAggregationFunction function=functionDefinition.getFunction();
  if (step == Step.FINAL) {
    checkArgument(functionDefinition.getInputs().size() == 1,"Expected a single input for an intermediate aggregation");
    intermediateChannel=functionDefinition.getInputs().get(0);
    aggregation=function.createGroupedIntermediateAggregation(functionDefinition.getConfidence());
  }
 else {
    int[] argumentChannels=new int[functionDefinition.getInputs().size()];
    for (int i=0; i < argumentChannels.length; i++) {
      argumentChannels[i]=functionDefinition.getInputs().get(i);
    }
    intermediateChannel=-1;
    aggregation=function.createGroupedAggregation(functionDefinition.getMask(),functionDefinition.getSampleWeight(),functionDefinition.getConfidence(),argumentChannels);
  }
  this.step=step;
}
