{
  StringBuilder regex=new StringBuilder(patternString.length() * 2);
  regex.append('^');
  boolean escaped=false;
  for (  char currentChar : patternString.toCharArray()) {
    if (shouldEscape && !escaped && currentChar == escapeChar) {
      escaped=true;
    }
 else {
switch (currentChar) {
case '%':
        if (escaped) {
          regex.append("%");
        }
 else {
          regex.append(".*");
        }
      escaped=false;
    break;
case '_':
  if (escaped) {
    regex.append("_");
  }
 else {
    regex.append('.');
  }
escaped=false;
break;
default :
switch (currentChar) {
case '\\':
case '^':
case '$':
case '.':
case '*':
regex.append('\\');
}
regex.append(currentChar);
escaped=false;
}
}
}
regex.append('$');
byte[] bytes=regex.toString().getBytes(Charsets.UTF_8);
return new Regex(bytes,0,bytes.length,0,UTF8Encoding.INSTANCE,SYNTAX);
}
