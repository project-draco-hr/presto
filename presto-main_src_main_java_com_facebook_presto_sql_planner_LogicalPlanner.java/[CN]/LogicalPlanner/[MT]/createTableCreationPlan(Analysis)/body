{
  QualifiedTableName destination=analysis.getCreateTableDestination().get();
  RelationPlan plan=createRelationPlan(analysis);
  TableMetadata tableMetadata=createTableMetadata(destination,getOutputTableColumns(plan),analysis.getCreateTableProperties(),plan.getSampleWeight().isPresent());
  if (plan.getSampleWeight().isPresent() && !metadata.canCreateSampledTables(session,destination.getCatalogName())) {
    throw new PrestoException(NOT_SUPPORTED,"Cannot write sampled data to a store that doesn't support sampling");
  }
  return createTableWriterPlan(analysis,plan,new CreateName(destination.getCatalogName(),tableMetadata),getVisibleColumnNames(tableMetadata));
}
