{
  QualifiedTableName destination=analysis.getCreateTableDestination().get();
  RelationPlan plan=createRelationPlan(analysis);
  TableMetadata tableMetadata=createTableMetadata(destination,getOutputTableColumns(plan),plan.getSampleWeight().isPresent());
  checkState(!plan.getSampleWeight().isPresent() || metadata.canCreateSampledTables(session,destination.getCatalogName()),"Cannot write sampled data to a store that doesn't support sampling");
  ImmutableList<Symbol> writerOutputs=ImmutableList.of(symbolAllocator.newSymbol("partialrows",BIGINT),symbolAllocator.newSymbol("fragment",VARCHAR));
  WriterTarget target=new CreateName(destination.getCatalogName(),tableMetadata);
  TableWriterNode writerNode=new TableWriterNode(idAllocator.getNextId(),plan.getRoot(),target,plan.getOutputSymbols(),getColumnNames(tableMetadata),writerOutputs,plan.getSampleWeight());
  List<Symbol> outputs=ImmutableList.of(symbolAllocator.newSymbol("rows",BIGINT));
  TableCommitNode commitNode=new TableCommitNode(idAllocator.getNextId(),writerNode,target,outputs);
  return new RelationPlan(commitNode,analysis.getOutputDescriptor(),outputs,Optional.<Symbol>absent());
}
