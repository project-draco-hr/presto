{
  checkState(analysis.getDestinations().size() == 1,"only a single table destination is currently supported");
  AnalyzedDestination destination=Iterables.getOnlyElement(analysis.getDestinations());
  TableMetadata tableMetadata=metadata.getTable(destination.getTableName());
  if (tableMetadata == null || !tableMetadata.getTableHandle().isPresent()) {
    AnalysisResult queryAnalysis=analysis.getAnalysis(destination);
    ImmutableList.Builder<ColumnMetadata> columns=ImmutableList.builder();
    for (    Field field : queryAnalysis.getOutputDescriptor().getFields()) {
      ColumnMetadata columnMetadata=new ColumnMetadata(field.getAttribute().get(),field.getType().getRawType());
      columns.add(columnMetadata);
    }
    tableMetadata=new TableMetadata(destination.getTableName(),columns.build());
    metadata.createTable(tableMetadata);
    tableMetadata=metadata.getTable(destination.getTableName());
  }
  return tableMetadata;
}
