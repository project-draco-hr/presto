{
  RelationPlan plan;
  if (analysis.getMaterializedViewDestination().isPresent()) {
    plan=createMaterializedViewWriterPlan(analysis);
  }
 else   if (analysis.getCreateTableDestination().isPresent()) {
    plan=createTableWriterPlan(analysis);
  }
 else {
    RelationPlanner planner=new RelationPlanner(analysis,symbolAllocator,idAllocator,metadata,session);
    plan=planner.process(analysis.getQuery(),null);
  }
  PlanNode root=createOutputPlan(plan,analysis);
  PlanSanityChecker.validate(root);
  for (  PlanOptimizer optimizer : planOptimizers) {
    root=optimizer.optimize(root,session,symbolAllocator.getTypes(),symbolAllocator,idAllocator);
  }
  PlanSanityChecker.validate(root);
  return new Plan(root,symbolAllocator);
}
