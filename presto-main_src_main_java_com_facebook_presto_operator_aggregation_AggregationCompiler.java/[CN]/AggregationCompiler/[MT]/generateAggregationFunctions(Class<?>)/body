{
  AggregationFunction metadata=clazz.getAnnotation(AggregationFunction.class);
  ApproximateAggregationFunction approximateMetadata=clazz.getAnnotation(ApproximateAggregationFunction.class);
  checkArgument(metadata != null || approximateMetadata != null,"Aggregation function annotation is missing");
  checkArgument(metadata == null || approximateMetadata == null,"Aggregation function cannot be exact and approximate");
  String name;
  if (metadata != null) {
    name=metadata.value();
  }
 else {
    name=approximateMetadata.value();
  }
  ImmutableList.Builder<InternalAggregationFunction> builder=ImmutableList.builder();
  for (  Class<?> stateClass : getStateClasses(clazz)) {
    AccumulatorStateSerializer<?> stateSerializer=new StateCompiler().generateStateSerializer(stateClass);
    Type intermediateType=stateSerializer.getSerializedType();
    Method intermediateInputFunction=getIntermediateInputFunction(clazz,stateClass);
    Method combineFunction=getCombineFunction(clazz,stateClass);
    AccumulatorStateFactory<?> stateFactory=new StateCompiler().generateStateFactory(stateClass);
    for (    Method outputFunction : getOutputFunctions(clazz,stateClass)) {
      for (      Method inputFunction : getInputFunctions(clazz,stateClass)) {
        List<Type> inputTypes=getInputTypes(inputFunction);
        Type outputType=getOutputType(outputFunction,stateSerializer);
        StringBuilder sb=new StringBuilder();
        sb.append(outputType.getName());
        for (        Type inputType : inputTypes) {
          sb.append(inputType.getName());
        }
        sb.append(CaseFormat.LOWER_UNDERSCORE.to(CaseFormat.UPPER_CAMEL,name.toLowerCase()));
        AccumulatorFactory factory=new AccumulatorCompiler().generateAccumulatorFactory(sb.toString(),inputFunction,intermediateInputFunction,combineFunction,outputFunction,stateClass,intermediateType,outputType,stateSerializer,stateFactory,approximateMetadata != null);
        builder.add(new GenericAggregationFunction(inputTypes,intermediateType,outputType,false,factory));
      }
    }
  }
  return builder.build();
}
