{
  ImmutableSet.Builder<ShardMetadata> shards=ImmutableSet.builder();
  long maxShardSizeBytes=maxShardSize.toBytes();
  long consumedBytes=0;
  long consumedRows=0;
  for (  ShardMetadata shard : shardMetadata) {
    if ((consumedBytes + shard.getUncompressedSize() > maxShardSizeBytes) || (consumedRows + shard.getRowCount() > maxShardRows)) {
      break;
    }
    consumedBytes+=shard.getUncompressedSize();
    consumedRows+=shard.getRowCount();
    shards.add(shard);
  }
  return shards.build();
}
