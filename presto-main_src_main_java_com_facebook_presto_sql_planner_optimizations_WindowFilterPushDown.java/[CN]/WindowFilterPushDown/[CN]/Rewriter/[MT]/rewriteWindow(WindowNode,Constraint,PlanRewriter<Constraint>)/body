{
  if (canOptimizeWindowFunction(node)) {
    PlanNode rewrittenSource=planRewriter.rewrite(node.getSource(),null);
    Optional<Integer> limit=getLimit(node,filter);
    if (node.getOrderBy().isEmpty()) {
      return new RowNumberNode(idAllocator.getNextId(),rewrittenSource,node.getPartitionBy(),getOnlyElement(node.getWindowFunctions().keySet()),limit);
    }
    if (limit.isPresent()) {
      return new TopNRowNumberNode(idAllocator.getNextId(),rewrittenSource,node.getPartitionBy(),node.getOrderBy(),node.getOrderings(),getOnlyElement(node.getWindowFunctions().keySet()),limit.get(),false);
    }
  }
  return planRewriter.defaultRewrite(node,null);
}
