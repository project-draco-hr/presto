{
  RelationPlan relationPlan=new RelationPlanner(analysis,symbolAllocator,idAllocator).process(Iterables.getOnlyElement(query.getFrom()),null);
  TranslationMap translations=new TranslationMap(relationPlan,analysis);
  translations.addMappings(relationPlan.getOutputMappings());
  PlanBuilder builder=new PlanBuilder(translations,relationPlan.getRoot());
  builder=filter(builder,query);
  builder=aggregate(builder,query);
  builder=window(builder,query);
  List<FieldOrExpression> orderBy=analysis.getOrderByExpressions(query);
  List<FieldOrExpression> outputs=analysis.getOutputExpressions(query);
  builder=project(builder,Iterables.concat(orderBy,outputs));
  Preconditions.checkArgument(analysis.getHaving(query) == null,"HAVING not yet supported");
  builder=distinct(builder,query,outputs,orderBy);
  builder=sort(builder,query);
  builder=project(builder,analysis.getOutputExpressions(query));
  builder=limit(builder,query);
  return builder;
}
