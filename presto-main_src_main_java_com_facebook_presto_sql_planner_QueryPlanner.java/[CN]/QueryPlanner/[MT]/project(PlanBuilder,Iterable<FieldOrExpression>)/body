{
  TranslationMap outputTranslations=new TranslationMap(subPlan.getRelationPlan(),analysis);
  ImmutableMap.Builder<Symbol,Expression> projections=ImmutableMap.builder();
  for (  FieldOrExpression fieldOrExpression : ImmutableSet.copyOf(expressions)) {
    Symbol symbol;
    if (fieldOrExpression.isFieldReference()) {
      Field field=subPlan.getRelationPlan().getDescriptor().getFields().get(fieldOrExpression.getFieldIndex());
      symbol=symbolAllocator.newSymbol(field);
    }
 else {
      Expression expression=fieldOrExpression.getExpression();
      symbol=symbolAllocator.newSymbol(expression,analysis.getType(expression));
    }
    projections.put(symbol,subPlan.rewrite(fieldOrExpression));
    outputTranslations.put(fieldOrExpression,symbol);
  }
  return new PlanBuilder(outputTranslations,new ProjectNode(idAllocator.getNextId(),subPlan.getRoot(),projections.build()));
}
