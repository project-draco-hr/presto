{
  PlanBuilder builder=planQueryBody(query);
  List<FieldOrExpression> orderBy=analysis.getOrderByExpressions(query);
  builder=handleSubqueries(builder,query,orderBy);
  List<FieldOrExpression> outputs=analysis.getOutputExpressions(query);
  builder=handleSubqueries(builder,query,outputs);
  builder=project(builder,Iterables.concat(orderBy,outputs));
  builder=sort(builder,query);
  builder=project(builder,analysis.getOutputExpressions(query));
  builder=limit(builder,query);
  return new RelationPlan(builder.getRoot(),analysis.getOutputDescriptor(query),computeOutputs(builder,analysis.getOutputExpressions(query)),builder.getSampleWeight());
}
