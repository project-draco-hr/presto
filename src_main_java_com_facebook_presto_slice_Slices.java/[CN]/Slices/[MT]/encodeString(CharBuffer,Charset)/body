{
  final CharsetEncoder encoder=getEncoder(charset);
  final ByteBuffer dst=ByteBuffer.allocate((int)((double)src.remaining() * encoder.maxBytesPerChar()));
  try {
    CoderResult cr=encoder.encode(src,dst,true);
    if (!cr.isUnderflow()) {
      cr.throwException();
    }
    cr=encoder.flush(dst);
    if (!cr.isUnderflow()) {
      cr.throwException();
    }
  }
 catch (  CharacterCodingException x) {
    throw new IllegalStateException(x);
  }
  dst.flip();
  return dst;
}
