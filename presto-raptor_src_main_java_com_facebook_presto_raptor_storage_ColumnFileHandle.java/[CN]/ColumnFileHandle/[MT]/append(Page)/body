{
  checkNotNull(page,"page is null");
  checkState(!committed.get(),"already committed: %s",shardUuid);
  Block[] blocks=page.getBlocks();
  int[] positionCount=new int[blocks.length];
  checkState(blocks.length == writers.size(),"Block count does not match writer count (%s vs %s)!",blocks.length,writers.size());
  int i=0;
  for (  BlocksFileWriter writer : writers.values()) {
    Block block=blocks[i];
    writer.append(block);
    positionCount[i]=block.getPositionCount();
    if (i > 0) {
      checkState(positionCount[i] == positionCount[i - 1],"different position count (%s vs. %s) for block!",positionCount[i],positionCount[i - 1]);
    }
    i++;
  }
  return positionCount[0];
}
