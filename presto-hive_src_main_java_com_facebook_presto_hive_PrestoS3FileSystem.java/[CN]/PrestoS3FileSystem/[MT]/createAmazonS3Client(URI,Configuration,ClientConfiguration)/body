{
  AWSCredentialsProvider credentials=getAwsCredentialsProvider(uri,hadoopConfig);
  Optional<EncryptionMaterialsProvider> emp=createEncryptionMaterialsProvider(hadoopConfig);
  AmazonS3Client client;
  if (emp.isPresent()) {
    client=new AmazonS3EncryptionClient(credentials,emp.get(),clientConfig,new CryptoConfiguration(),METRIC_COLLECTOR);
  }
 else {
    client=new AmazonS3Client(credentials,clientConfig,METRIC_COLLECTOR);
  }
  if (pinS3ClientToCurrentRegion) {
    Region region=Regions.getCurrentRegion();
    if (region != null) {
      client.setRegion(region);
    }
  }
  return client;
}
