{
  Optional<AWSCredentials> credentials=getAwsCredentials(uri,conf);
  if (credentials.isPresent()) {
    return new StaticCredentialsProvider(credentials.get());
  }
  if (useInstanceCredentials) {
    return new InstanceProfileCredentialsProvider();
  }
  throw new RuntimeException("S3 credentials not configured");
}
