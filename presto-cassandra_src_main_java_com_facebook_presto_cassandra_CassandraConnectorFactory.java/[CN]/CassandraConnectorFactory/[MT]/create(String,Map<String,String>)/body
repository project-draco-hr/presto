{
  checkNotNull(config,"config is null");
  try (ThreadContextClassLoader ignored=new ThreadContextClassLoader(classLoader)){
    Bootstrap app=new Bootstrap(new NodeModule(),new MBeanModule(),new JsonModule(),new CassandraClientModule(connectorId),new Module(){
      @Override public void configure(      Binder binder){
        MBeanServer platformMBeanServer=ManagementFactory.getPlatformMBeanServer();
        binder.bind(MBeanServer.class).toInstance(new RebindSafeMBeanServer(platformMBeanServer));
      }
    }
);
    Injector injector=app.strictConfig().doNotInitializeLogging().setRequiredConfigurationProperties(config).setOptionalConfigurationProperties(optionalConfig).initialize();
    CassandraMetadata metadata=injector.getInstance(CassandraMetadata.class);
    CassandraSplitManager splitManager=injector.getInstance(CassandraSplitManager.class);
    ConnectorRecordSetProvider recordSetProvider=injector.getInstance(CassandraRecordSetProvider.class);
    CassandraHandleResolver handleResolver=injector.getInstance(CassandraHandleResolver.class);
    ImmutableClassToInstanceMap.Builder<Object> builder=ImmutableClassToInstanceMap.builder();
    builder.put(ConnectorMetadata.class,new ClassLoaderSafeConnectorMetadata(metadata,classLoader));
    builder.put(ConnectorSplitManager.class,new ClassLoaderSafeConnectorSplitManager(splitManager,classLoader));
    builder.put(ConnectorRecordSetProvider.class,new ClassLoaderSafeConnectorRecordSetProvider(recordSetProvider,classLoader));
    builder.put(ConnectorHandleResolver.class,new ClassLoaderSafeConnectorHandleResolver(handleResolver,classLoader));
    return new CassandraConnector(builder.build());
  }
 catch (  Exception e) {
    throw Throwables.propagate(e);
  }
}
