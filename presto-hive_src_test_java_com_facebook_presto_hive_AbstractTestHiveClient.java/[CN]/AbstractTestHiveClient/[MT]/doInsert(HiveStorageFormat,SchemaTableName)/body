{
  doCreateEmptyTable(tableName,storageFormat,CREATE_TABLE_COLUMNS);
  MaterializedResult.Builder resultBuilder=MaterializedResult.resultBuilder(SESSION,CREATE_TABLE_DATA.getTypes());
  for (int i=0; i < 3; i++) {
    ConnectorSession session=newSession();
    ConnectorTransactionHandle transaction=newTransaction();
    ConnectorMetadata metadata=newMetadata();
    ConnectorTableHandle tableHandle=getTableHandle(metadata,tableName);
    ConnectorInsertTableHandle insertTableHandle=metadata.beginInsert(session,tableHandle);
    ConnectorPageSink sink=pageSinkProvider.createPageSink(transaction,session,insertTableHandle);
    sink.appendPage(CREATE_TABLE_DATA.toPage(),null);
    Collection<Slice> fragments=sink.finish();
    metadata.finishInsert(session,insertTableHandle,fragments);
    List<ColumnHandle> columnHandles=ImmutableList.copyOf(metadata.getColumnHandles(session,tableHandle).values());
    ConnectorTableMetadata tableMetadata=metadata.getTableMetadata(session,getTableHandle(metadata,tableName));
    assertEquals(tableMetadata.getOwner(),session.getUser());
    assertEquals(tableMetadata.getColumns(),CREATE_TABLE_COLUMNS);
    resultBuilder.rows(CREATE_TABLE_DATA.getMaterializedRows());
    MaterializedResult result=readTable(tableHandle,columnHandles,session,TupleDomain.<ColumnHandle>all(),OptionalInt.empty(),Optional.empty());
    assertEqualsIgnoreOrder(result.getMaterializedRows(),resultBuilder.build().getMaterializedRows());
  }
  Set<String> existingFiles=listAllDataFiles(tableName.getSchemaName(),tableName.getTableName());
  assertFalse(existingFiles.isEmpty());
  ConnectorSession session=newSession();
  ConnectorTransactionHandle transaction=newTransaction();
  ConnectorMetadata metadata=newMetadata();
  ConnectorTableHandle tableHandle=getTableHandle(metadata,tableName);
  List<ColumnHandle> columnHandles=ImmutableList.copyOf(metadata.getColumnHandles(session,tableHandle).values());
  ConnectorInsertTableHandle insertTableHandle=metadata.beginInsert(session,tableHandle);
  ConnectorPageSink sink=pageSinkProvider.createPageSink(transaction,session,insertTableHandle);
  sink.appendPage(CREATE_TABLE_DATA.toPage(),null);
  sink.appendPage(CREATE_TABLE_DATA.toPage(),null);
  sink.finish();
  assertEquals(listAllDataFiles(tableName.getSchemaName(),tableName.getTableName()),existingFiles);
  Set<String> tempFiles=listAllDataFiles(getStagingPathRoot(insertTableHandle));
  assertTrue(!tempFiles.isEmpty());
  for (  String filePath : tempFiles) {
    assertTrue(new Path(filePath).getName().startsWith(getFilePrefix(insertTableHandle)));
  }
  rollback(metadata);
  MaterializedResult result=readTable(tableHandle,columnHandles,session,TupleDomain.<ColumnHandle>all(),OptionalInt.empty(),Optional.empty());
  assertEqualsIgnoreOrder(result.getMaterializedRows(),resultBuilder.build().getMaterializedRows());
  assertEquals(listAllDataFiles(tableName.getSchemaName(),tableName.getTableName()),existingFiles);
  assertTrue(listAllDataFiles(getStagingPathRoot(insertTableHandle)).isEmpty());
}
