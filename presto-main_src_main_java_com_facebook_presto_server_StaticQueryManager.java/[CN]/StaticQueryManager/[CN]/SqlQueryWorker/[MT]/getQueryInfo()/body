{
  ImmutableMap.Builder<String,List<QueryTaskInfo>> map=ImmutableMap.builder();
  for (  Entry<Integer,List<HttpTaskClient>> stage : stages.entrySet()) {
    map.put(String.valueOf(stage.getKey()),ImmutableList.copyOf(Iterables.transform(stage.getValue(),new Function<QueryTask,QueryTaskInfo>(){
      @Override public QueryTaskInfo apply(      QueryTask queryTask){
        QueryTaskInfo taskInfo=queryTask.getQueryTaskInfo();
        if (taskInfo == null) {
          RuntimeException exception=new RuntimeException(String.format("Query %s task %s has been deleted",queryId,queryTask.getTaskId()));
          cancel();
          throw exception;
        }
        return taskInfo;
      }
    }
)));
  }
  ImmutableMap<String,List<QueryTaskInfo>> stages=map.build();
  State overallState=queryState.get();
  if (!stages.isEmpty()) {
    if (overallState == State.PREPARING) {
      overallState=State.RUNNING;
      queryState.set(overallState);
    }
    Iterable<State> taskStates=transform(concat(stages.values()),new Function<QueryTaskInfo,State>(){
      @Override public State apply(      QueryTaskInfo queryTaskInfo){
        return queryTaskInfo.getState();
      }
    }
);
    if (overallState == State.PREPARING || overallState == State.RUNNING) {
      if (Iterables.any(taskStates,Predicates.equalTo(State.FAILED))) {
        overallState=State.FAILED;
        queryState.set(overallState);
        cancel();
      }
 else       if (Iterables.any(taskStates,Predicates.equalTo(State.CANCELED))) {
        overallState=State.CANCELED;
        queryState.set(overallState);
        cancel();
      }
 else       if (Iterables.all(taskStates,Predicates.equalTo(State.FINISHED))) {
        overallState=State.FINISHED;
        queryState.set(overallState);
      }
    }
  }
  return new QueryInfo(queryId,tupleInfos,overallState,outputStage.get(),stages);
}
