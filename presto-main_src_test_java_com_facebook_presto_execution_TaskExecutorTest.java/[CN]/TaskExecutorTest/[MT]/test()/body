{
  TaskExecutor taskExecutor=new TaskExecutor(4,8);
  taskExecutor.start();
  try {
    TaskHandle taskHandle=taskExecutor.addTask(new TaskId("test","test","test"));
    Phaser beginPhase=new Phaser();
    beginPhase.register();
    Phaser verificationComplete=new Phaser();
    verificationComplete.register();
    TestingJob driver1=new TestingJob(beginPhase,verificationComplete,10);
    ListenableFuture<?> future1=getOnlyElement(taskExecutor.enqueueSplits(taskHandle,true,ImmutableList.of(driver1)));
    TestingJob driver2=new TestingJob(beginPhase,verificationComplete,10);
    ListenableFuture<?> future2=getOnlyElement(taskExecutor.enqueueSplits(taskHandle,true,ImmutableList.of(driver2)));
    assertEquals(driver1.getCompletedPhases(),0);
    assertEquals(driver2.getCompletedPhases(),0);
    beginPhase.arriveAndAwaitAdvance();
    assertEquals(driver1.getCompletedPhases(),0);
    assertEquals(driver2.getCompletedPhases(),0);
    verificationComplete.arriveAndAwaitAdvance();
    beginPhase.arriveAndAwaitAdvance();
    assertEquals(driver1.getCompletedPhases(),1);
    assertEquals(driver2.getCompletedPhases(),1);
    verificationComplete.arriveAndAwaitAdvance();
    TestingJob driver3=new TestingJob(beginPhase,verificationComplete,10);
    ListenableFuture<?> future3=getOnlyElement(taskExecutor.enqueueSplits(taskHandle,false,ImmutableList.of(driver3)));
    beginPhase.arriveAndAwaitAdvance();
    assertEquals(driver1.getCompletedPhases(),2);
    assertEquals(driver2.getCompletedPhases(),2);
    assertEquals(driver3.getCompletedPhases(),0);
    verificationComplete.arriveAndAwaitAdvance();
    beginPhase.arriveAndAwaitAdvance();
    for (int i=0; i < 7; i++) {
      verificationComplete.arriveAndAwaitAdvance();
      beginPhase.arriveAndAwaitAdvance();
      assertEquals(beginPhase.getPhase(),verificationComplete.getPhase() + 1);
    }
    assertEquals(driver1.getCompletedPhases(),10);
    assertEquals(driver2.getCompletedPhases(),10);
    assertEquals(driver3.getCompletedPhases(),8);
    future1.get(1,TimeUnit.SECONDS);
    future2.get(1,TimeUnit.SECONDS);
    verificationComplete.arriveAndAwaitAdvance();
    beginPhase.arriveAndAwaitAdvance();
    verificationComplete.arriveAndAwaitAdvance();
    beginPhase.arriveAndAwaitAdvance();
    assertEquals(driver1.getCompletedPhases(),10);
    assertEquals(driver2.getCompletedPhases(),10);
    assertEquals(driver3.getCompletedPhases(),10);
    future3.get(1,TimeUnit.SECONDS);
    verificationComplete.arriveAndAwaitAdvance();
    assertEquals(driver1.getFirstPhase(),0);
    assertEquals(driver2.getFirstPhase(),0);
    assertEquals(driver3.getFirstPhase(),2);
    assertEquals(driver1.getLastPhase(),10);
    assertEquals(driver2.getLastPhase(),10);
    assertEquals(driver3.getLastPhase(),12);
  }
  finally {
    taskExecutor.stop();
  }
}
