{
  QueryInfo queryInfo=waitForQuery(queryClient);
  if (queryInfo == null) {
    throw new RuntimeException("Query is gone (server restarted?)");
  }
  if (queryInfo.getState().isDone()) {
switch (queryInfo.getState()) {
case CANCELED:
      throw new RuntimeException(format("Query was canceled (#%s)",queryInfo.getQueryId()));
case FAILED:
    throw new RuntimeException(failureMessage(queryInfo));
default :
  throw new RuntimeException(format("Query finished with no output (#%s)",queryInfo.getQueryId()));
}
}
return queryInfo;
}
