{
  CompilerContext context=new CompilerContext();
  Block body=definition.declareMethod(a(PUBLIC),"evaluateFinal",type(void.class),arg("groupId",int.class),arg("out",BlockBuilder.class)).getBody().comment("state.setGroupId(groupId)").pushThis().getField(stateField).getVariable("groupId").intToLong().invokeVirtual(stateField.getType(),"setGroupId",type(void.class),type(long.class));
  if (outputFunction != null) {
    body.comment("output(state, out)").pushThis().getField(stateField);
    if (approximate) {
      checkNotNull(confidenceField,"confidenceField is null");
      body.pushThis().getField(confidenceField);
    }
    body.getVariable("out").append(invoke(context,callSiteBinder.bind(outputFunction),"output"));
  }
 else {
    checkArgument(!approximate,"Approximate aggregations must specify an output function");
    body.comment("stateSerializer.serialize(state, out)").pushThis().getField(stateSerializerField).pushThis().getField(stateField).getVariable("out").invokeInterface(AccumulatorStateSerializer.class,"serialize",void.class,Object.class,BlockBuilder.class);
  }
  body.ret();
}
