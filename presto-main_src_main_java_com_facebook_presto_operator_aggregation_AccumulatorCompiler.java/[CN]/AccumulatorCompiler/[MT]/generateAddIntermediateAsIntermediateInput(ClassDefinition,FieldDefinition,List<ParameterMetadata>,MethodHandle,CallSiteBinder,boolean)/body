{
  MethodDefinition method=declareAddIntermediate(definition,grouped);
  Scope scope=method.getScope();
  Block body=method.getBody();
  if (grouped) {
    generateEnsureCapacity(scope,stateField,body);
  }
  Variable positionVariable=scope.declareVariable(int.class,"position");
  Block loopBody=generateInvokeInputFunction(scope,stateField,positionVariable,null,ImmutableList.of(scope.getVariable("block")),parameterMetadatas,intermediateInputFunction,callSiteBinder,grouped);
  body.append(generateBlockNonNullPositionForLoop(scope,positionVariable,loopBody)).ret();
}
