{
  DateTime now=DateTime.now();
  DateTime oldestAllowedHeartbeat=now.minus((long)clientTimeout.toMillis());
  for (  QueryExecution queryExecution : queries.values()) {
    try {
      QueryInfo queryInfo=queryExecution.getQueryInfo();
      if (queryInfo.getState().isDone()) {
        continue;
      }
      DateTime lastHeartbeat=queryInfo.getQueryStats().getLastHeartbeat();
      if (lastHeartbeat != null && lastHeartbeat.isBefore(oldestAllowedHeartbeat)) {
        log.info("Failing abandoned query %s",queryInfo.getQueryId());
        queryExecution.fail(new AbandonedException("Query " + queryInfo.getQueryId(),lastHeartbeat,now));
      }
    }
 catch (    Exception e) {
      log.warn(e,"Error while inspecting age of query %s",queryExecution.getQueryInfo().getQueryId());
    }
  }
}
