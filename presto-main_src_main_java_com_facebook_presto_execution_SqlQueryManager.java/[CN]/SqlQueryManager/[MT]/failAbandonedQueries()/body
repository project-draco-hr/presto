{
  DateTime now=DateTime.now();
  DateTime oldestAllowedHeartBeat=now.minus((long)clientTimeout.toMillis());
  for (  QueryExecution queryExecution : queries.values()) {
    try {
      QueryInfo queryInfo=queryExecution.getQueryInfo();
      if (queryInfo.getState().isDone()) {
        continue;
      }
      DateTime lastHeartBeat=queryInfo.getQueryStats().getLastHeartBeat();
      if (lastHeartBeat != null && lastHeartBeat.isBefore(oldestAllowedHeartBeat)) {
        log.info("Failing abandoned query %s",queryInfo.getQueryId());
        queryExecution.fail(new AbandonedException("Query " + queryInfo.getQueryId(),lastHeartBeat,now));
      }
    }
 catch (    Exception e) {
      log.warn(e,"Error while inspecting age of query %s",queryExecution.getQueryInfo().getQueryId());
    }
  }
}
