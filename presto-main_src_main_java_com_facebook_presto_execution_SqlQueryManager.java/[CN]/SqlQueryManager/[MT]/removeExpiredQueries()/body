{
  DateTime timeHorizon=DateTime.now().minus(maxQueryAge.toMillis());
  while (expirationQueue.size() > maxQueryHistory) {
    QueryInfo queryInfo=expirationQueue.peek().getQueryInfo();
    if (queryInfo.getQueryStats().getEndTime().isAfter(timeHorizon)) {
      return;
    }
    QueryId queryId=queryInfo.getQueryId();
    log.debug("Remove query %s",queryId);
    QueryExecution query=queries.remove(queryId);
    if (query != null) {
      log.error("Query %s is %s, but still has a QueryExecution registered",queryId,queryInfo.getState());
      query.fail(new AbandonedException("Query " + queryId,queryInfo.getQueryStats().getLastHeartbeat(),DateTime.now()));
    }
    expirationQueue.remove();
  }
}
