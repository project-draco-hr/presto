{
  List<QueryExecution> sortedQueries=IterableTransformer.on(queries.values()).select(compose(not(isNull()),endTimeGetter())).orderBy(Ordering.natural().onResultOf(endTimeGetter())).list();
  int toRemove=Math.max(sortedQueries.size() - maxQueryHistory,0);
  DateTime oldestAllowedQuery=DateTime.now().minus(maxQueryAge.toMillis());
  for (  QueryExecution queryExecution : sortedQueries) {
    try {
      DateTime endTime=queryExecution.getQueryInfo().getQueryStats().getEndTime();
      if ((endTime.isBefore(oldestAllowedQuery) || toRemove > 0) && isAbandoned(queryExecution)) {
        removeQuery(queryExecution.getQueryInfo().getQueryId());
        --toRemove;
      }
    }
 catch (    Exception e) {
      log.warn(e,"Error while inspecting age of query %s",queryExecution.getQueryInfo().getQueryId());
    }
  }
}
