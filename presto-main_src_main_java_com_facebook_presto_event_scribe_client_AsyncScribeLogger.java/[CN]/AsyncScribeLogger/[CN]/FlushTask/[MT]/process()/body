{
  if (failedBatch != null) {
    if (!flushToScribe(failedBatch)) {
      return false;
    }
    failedBatch=null;
  }
  BatchBuilder batchBuilder=new BatchBuilder();
  LogEntry logEntry=queue.take();
  do {
    batchBuilder.add(logEntry);
    if (batchBuilder.getSize().toBytes() >= maxBatchSize.toBytes()) {
      if (!flushToScribe(batchBuilder.build())) {
        return false;
      }
      batchBuilder=new BatchBuilder();
    }
    logEntry=queue.poll();
  }
 while (logEntry != null);
  if (!batchBuilder.isEmpty()) {
    if (!flushToScribe(batchBuilder.build())) {
      return false;
    }
  }
  return true;
}
