{
  ClientSession session=new ClientSession(coordinator.getBaseUrl(),"testuser","default","default",true);
  try (HttpQueryClient client=new HttpQueryClient(session,sql,httpClient,queryInfoCodec)){
    boolean loggedUri=false;
    while (true) {
      QueryInfo queryInfo=client.getQueryInfo(false);
      if (!loggedUri && queryInfo.getSelf() != null) {
        log.info("Query %s: %s?pretty",queryInfo.getQueryId(),queryInfo.getSelf());
        loggedUri=true;
      }
      QueryState state=queryInfo.getState();
      if (state == QueryState.FAILED) {
        FailureInfo failureInfo=Iterables.getFirst(queryInfo.getFailures(),null);
        if (failureInfo != null) {
          throw failureInfo.toException();
        }
        throw new RuntimeException("Query " + queryInfo.getQueryId() + " failed for an unknown reason");
      }
 else       if (state == QueryState.CANCELED) {
        throw new RuntimeException("Query was cancelled");
      }
 else       if (state == QueryState.RUNNING || state.isDone()) {
        break;
      }
      Uninterruptibles.sleepUninterruptibly(100,TimeUnit.MILLISECONDS);
    }
    MaterializedResult materializedResult=materialize(client.getResultsOperator());
    QueryInfo queryInfo=client.getQueryInfo(true);
    if (queryInfo.getState() != QueryState.FINISHED) {
      throw new RuntimeException("Expected query to be FINISHED, but is " + queryInfo.getState());
    }
    return materializedResult;
  }
 }
