{
  ClientSession session=new ClientSession(coordinator.getBaseUrl(),"testuser","default","default",true);
  try (StatementClient client=new StatementClient(httpClient,queryResultsCodec,session,sql)){
    AtomicBoolean loggedUri=new AtomicBoolean(false);
    ImmutableList.Builder<Tuple> rows=ImmutableList.builder();
    TupleInfo tupleInfo=null;
    while (true) {
      QueryResults results=client.current();
      if (!loggedUri.getAndSet(true)) {
        log.info("Query %s: %s?pretty",results.getQueryId(),results.getQueryInfoUri());
      }
      if ((tupleInfo == null) && (results.getColumns() != null)) {
        tupleInfo=getTupleInfo(results.getColumns());
      }
      if (results.getData() != null) {
        rows.addAll(transform(results.getData(),dataToTuple(tupleInfo)));
      }
      if (!client.hasNext()) {
        String state=results.getStats().getState();
        if ("FINISHED".equals(state)) {
          return new MaterializedResult(rows.build(),tupleInfo);
        }
        QueryError error=results.getError();
        if (error != null) {
          if (error.getFailureInfo() != null) {
            throw error.getFailureInfo().toException();
          }
          throw new RuntimeException("Query failed: " + error.getMessage());
        }
        throw new RuntimeException("Query failed for an unknown reason");
      }
      client.next();
    }
  }
 }
