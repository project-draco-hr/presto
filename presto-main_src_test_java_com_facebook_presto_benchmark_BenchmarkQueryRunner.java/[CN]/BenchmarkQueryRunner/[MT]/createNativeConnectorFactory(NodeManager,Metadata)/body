{
  try {
    File dataDir=new File(System.getProperty("tpchCacheDir","/tmp/tpch_data_cache"));
    File databaseDir=new File(dataDir,"db");
    IDBI localStorageManagerDbi=createDataSource(databaseDir,"StorageManager");
    DatabaseLocalStorageManagerConfig storageManagerConfig=new DatabaseLocalStorageManagerConfig().setCompressed(false).setDataDirectory(new File(dataDir,"data"));
    LocalStorageManager localStorageManager=new DatabaseLocalStorageManager(localStorageManagerDbi,storageManagerConfig);
    NativeDataStreamProvider nativeDataStreamProvider=new NativeDataStreamProvider(localStorageManager);
    NativeRecordSinkProvider nativeRecordSinkProvider=new NativeRecordSinkProvider(localStorageManager,nodeManager.getCurrentNode().getNodeIdentifier());
    IDBI metadataDbi=createDataSource(databaseDir,"Metastore");
    NativeConnectorFactory nativeConnectorFactory=new NativeConnectorFactory(nativeDataStreamProvider,nativeRecordSinkProvider);
    nativeConnectorFactory.setDbi(metadataDbi);
    DatabaseShardManager shardManager=new DatabaseShardManager(metadataDbi);
    nativeConnectorFactory.setShardManager(shardManager);
    nativeConnectorFactory.setSplitManager(new NativeSplitManager(nodeManager,shardManager,metadata));
    return nativeConnectorFactory;
  }
 catch (  InterruptedException e) {
    Thread.currentThread().interrupt();
    throw Throwables.propagate(e);
  }
catch (  Exception e) {
    throw Throwables.propagate(e);
  }
}
