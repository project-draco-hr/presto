{
  final Map<QualifiedName,Integer> resolvedNames=analysis.getResolvedNames(expression);
  Preconditions.checkArgument(resolvedNames != null,"No resolved names for expression %s",expression);
  return ExpressionTreeRewriter.rewriteWith(new ExpressionRewriter<Void>(){
    @Override public Expression rewriteQualifiedNameReference(    QualifiedNameReference node,    Void context,    ExpressionTreeRewriter<Void> treeRewriter){
      QualifiedName name=node.getName();
      Integer fieldIndex=resolvedNames.get(name);
      Preconditions.checkState(fieldIndex != null,"No field mapping for name '%s'",name);
      Symbol symbol=rewriteBase.getSymbol(fieldIndex);
      Preconditions.checkState(symbol != null,"No symbol mapping for name '%s' (%s)",name,fieldIndex);
      return new QualifiedNameReference(symbol.toQualifiedName());
    }
  }
,expression);
}
