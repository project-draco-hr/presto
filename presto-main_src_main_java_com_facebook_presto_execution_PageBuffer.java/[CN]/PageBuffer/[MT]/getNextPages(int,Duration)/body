{
  Preconditions.checkArgument(maxPageCount > 0,"maxPageCount must be at least 1");
  Preconditions.checkNotNull(maxWait,"maxWait is null");
  List<Page> pages=new ArrayList<>(maxPageCount);
  if (!isFinished()) {
    Page page=buffer.poll((long)maxWait.convertTo(NANOSECONDS),NANOSECONDS);
    if (page != null) {
      pages.add(page);
      buffer.drainTo(pages,maxPageCount - 1);
      if (removeEndOfDataMarker(pages) || (state.get() == BufferState.FINISHING && buffer.isEmpty())) {
        cancel();
      }
    }
  }
  return ImmutableList.copyOf(pages);
}
