{
  checkNotNull(duration,"duration is null");
  checkState(!Thread.holdsLock(this),"Can not process for a duration while holding a lock on the %s",getClass().getSimpleName());
  long maxRuntime=duration.roundTo(TimeUnit.NANOSECONDS);
  long start=System.nanoTime();
  do {
    ListenableFuture<?> future=process();
    if (!future.isDone()) {
      return future;
    }
  }
 while (System.nanoTime() - start < maxRuntime && !isFinished());
  return NOT_BLOCKED;
}
