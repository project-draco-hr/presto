{
  if (!enabled) {
    return;
  }
  long totalBytes=0;
  for (  QueryExecution query : queries) {
    long bytes=query.getTotalMemoryReservation();
    DataSize sessionMaxQueryMemory=getQueryMaxMemory(query.getSession(),maxQueryMemory);
    long queryMemoryLimit=Math.min(maxQueryMemory.toBytes(),sessionMaxQueryMemory.toBytes());
    totalBytes+=bytes;
    if (bytes > queryMemoryLimit) {
      query.fail(new ExceededMemoryLimitException("Query",DataSize.succinctDataSize(queryMemoryLimit,Unit.BYTE)));
    }
  }
  clusterMemoryUsageBytes.set(totalBytes);
  Map<MemoryPoolId,Integer> countByPool=new HashMap<>();
  for (  QueryExecution query : queries) {
    MemoryPoolId id=query.getMemoryPool().getId();
    countByPool.put(id,countByPool.getOrDefault(id,0) + 1);
  }
  updatePools(countByPool);
  updateNodes(updateAssignments(queries));
}
