{
  ImmutableSet.Builder<Symbol> expectedInputs=ImmutableSet.<Symbol>builder().addAll(expectedOutputs).addAll(node.getPartitionBy()).addAll(node.getOrderBy());
  if (node.getFrame().getStartValue().isPresent()) {
    expectedInputs.add(node.getFrame().getStartValue().get());
  }
  if (node.getFrame().getEndValue().isPresent()) {
    expectedInputs.add(node.getFrame().getEndValue().get());
  }
  if (node.getHashSymbol().isPresent()) {
    expectedInputs.add(node.getHashSymbol().get());
  }
  ImmutableMap.Builder<Symbol,Signature> functions=ImmutableMap.builder();
  ImmutableMap.Builder<Symbol,FunctionCall> functionCalls=ImmutableMap.builder();
  for (  Map.Entry<Symbol,FunctionCall> entry : node.getWindowFunctions().entrySet()) {
    Symbol symbol=entry.getKey();
    if (expectedOutputs.contains(symbol)) {
      FunctionCall call=entry.getValue();
      expectedInputs.addAll(DependencyExtractor.extractUnique(call));
      functionCalls.put(symbol,call);
      functions.put(symbol,node.getSignatures().get(symbol));
    }
  }
  PlanNode source=planRewriter.rewrite(node.getSource(),expectedInputs.build());
  return new WindowNode(node.getId(),source,node.getPartitionBy(),node.getOrderBy(),node.getOrderings(),node.getFrame(),functionCalls.build(),functions.build(),node.getHashSymbol());
}
