{
  ImmutableSet.Builder<Symbol> expectedInputs=ImmutableSet.<Symbol>builder().addAll(node.getGroupBy());
  ImmutableMap.Builder<Symbol,FunctionHandle> functions=ImmutableMap.builder();
  ImmutableMap.Builder<Symbol,FunctionCall> functionCalls=ImmutableMap.builder();
  ImmutableMap.Builder<Symbol,Symbol> masks=ImmutableMap.builder();
  for (  Map.Entry<Symbol,FunctionCall> entry : node.getAggregations().entrySet()) {
    Symbol symbol=entry.getKey();
    if (expectedOutputs.contains(symbol)) {
      FunctionCall call=entry.getValue();
      expectedInputs.addAll(DependencyExtractor.extractUnique(call));
      if (node.getMasks().containsKey(symbol)) {
        expectedInputs.add(node.getMasks().get(symbol));
        masks.put(symbol,node.getMasks().get(symbol));
      }
      functionCalls.put(symbol,call);
      functions.put(symbol,node.getFunctions().get(symbol));
    }
  }
  PlanNode source=planRewriter.rewrite(node.getSource(),expectedInputs.build());
  return new AggregationNode(node.getId(),source,node.getGroupBy(),functionCalls.build(),functions.build(),masks.build());
}
