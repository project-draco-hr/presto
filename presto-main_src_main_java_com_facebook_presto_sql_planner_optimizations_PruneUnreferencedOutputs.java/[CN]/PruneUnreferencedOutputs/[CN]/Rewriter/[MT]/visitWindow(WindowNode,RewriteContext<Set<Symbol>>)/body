{
  ImmutableSet.Builder<Symbol> expectedInputs=ImmutableSet.<Symbol>builder().addAll(context.get()).addAll(node.getPartitionBy()).addAll(node.getOrderBy());
  if (node.getFrame().getStartValue().isPresent()) {
    expectedInputs.add(node.getFrame().getStartValue().get());
  }
  if (node.getFrame().getEndValue().isPresent()) {
    expectedInputs.add(node.getFrame().getEndValue().get());
  }
  if (node.getHashSymbol().isPresent()) {
    expectedInputs.add(node.getHashSymbol().get());
  }
  ImmutableMap.Builder<Symbol,WindowNode.Function> functionsBuilder=ImmutableMap.builder();
  for (  Map.Entry<Symbol,WindowNode.Function> entry : node.getWindowFunctions().entrySet()) {
    Symbol symbol=entry.getKey();
    if (context.get().contains(symbol)) {
      FunctionCall call=entry.getValue().getFunctionCall();
      expectedInputs.addAll(DependencyExtractor.extractUnique(call));
      functionsBuilder.put(symbol,new WindowNode.Function(call,entry.getValue().getSignature()));
    }
  }
  PlanNode source=context.rewrite(node.getSource(),expectedInputs.build());
  Map<Symbol,WindowNode.Function> functions=functionsBuilder.build();
  if (functions.size() == 0) {
    return source;
  }
  return new WindowNode(node.getId(),source,node.getSpecification(),functions,node.getHashSymbol(),node.getPrePartitionedInputs(),node.getPreSortedOrderPrefix());
}
