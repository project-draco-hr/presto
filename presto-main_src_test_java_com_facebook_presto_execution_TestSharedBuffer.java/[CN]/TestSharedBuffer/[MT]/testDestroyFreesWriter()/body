{
  OutputBuffers outputBuffers=INITIAL_EMPTY_OUTPUT_BUFFERS.withBuffer("queue",new UnpartitionedPagePartitionFunction()).withNoMoreBufferIds();
  SharedBuffer sharedBuffer=new SharedBuffer(sizeOfPages(5),outputBuffers);
  assertFalse(sharedBuffer.isFinished());
  ExecutorService executor=Executors.newCachedThreadPool();
  for (int i=0; i < 5; i++) {
    addPage(sharedBuffer,createPage(i));
  }
  AddPagesJob addPagesJob=new AddPagesJob(sharedBuffer,createPage(2),createPage(3));
  executor.submit(addPagesJob);
  addPagesJob.waitForStarted();
  addPagesJob.assertBlockedWithCount(2);
  assertEquals(sharedBuffer.get("queue",0,sizeOfPages(1),MAX_WAIT).size(),1);
  sharedBuffer.acknowledge("queue",1);
  addPagesJob.assertBlockedWithCount(1);
  sharedBuffer.destroy();
  assertFinished(sharedBuffer);
  addPagesJob.waitForFinished();
}
