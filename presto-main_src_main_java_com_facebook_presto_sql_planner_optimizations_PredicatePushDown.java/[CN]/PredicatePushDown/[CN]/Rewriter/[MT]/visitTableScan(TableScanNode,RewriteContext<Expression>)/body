{
  DomainTranslator.ExtractionResult extractionResult=DomainTranslator.fromPredicate(metadata,session,context.get(),symbolAllocator.getTypes(),node.getAssignments());
  Expression extractionRemainingExpression=extractionResult.getRemainingExpression();
  TupleDomain<ColumnHandle> tupleDomain=extractionResult.getTupleDomain();
  if (node.getGeneratedPartitions().isPresent()) {
    tupleDomain=tupleDomain.intersect(node.getGeneratedPartitions().get().getTupleDomainInput()).intersect(node.getPartitionsDomainSummary());
  }
  PartitionResult matchingPartitions=splitManager.getPartitions(node.getTable(),Optional.of(tupleDomain));
  List<Partition> partitions=matchingPartitions.getPartitions();
  TupleDomain<ColumnHandle> undeterminedTupleDomain=matchingPartitions.getUndeterminedTupleDomain();
  Expression unevaluatedDomainPredicate=DomainTranslator.toPredicate(undeterminedTupleDomain,ImmutableBiMap.copyOf(node.getAssignments()).inverse(),symbolAllocator.getTypes());
  Expression postScanPredicate=combineConjuncts(unevaluatedDomainPredicate,extractionRemainingExpression);
  partitions=ImmutableList.copyOf(filter(partitions,not(shouldPrunePartition(postScanPredicate,node.getAssignments()))));
  GeneratedPartitions generatedPartitions=new GeneratedPartitions(tupleDomain,partitions);
  PlanNode output=node;
  if (!node.getGeneratedPartitions().equals(Optional.of(generatedPartitions))) {
    Expression originalConstraint=node.getOriginalConstraint() == null ? context.get() : node.getOriginalConstraint();
    output=new TableScanNode(node.getId(),node.getTable(),node.getOutputSymbols(),node.getAssignments(),originalConstraint,Optional.of(generatedPartitions));
  }
  if (!postScanPredicate.equals(BooleanLiteral.TRUE_LITERAL)) {
    output=new FilterNode(idAllocator.getNextId(),output,postScanPredicate);
  }
  return output;
}
