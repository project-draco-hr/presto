{
  final long partitionId=getOrCreatePartitionId(tableId,partition,partitionKeys);
  dbi.inTransaction(new VoidTransactionCallback(){
    @Override protected void execute(    Handle handle,    TransactionStatus status){
      ShardManagerDao dao=handle.attach(ShardManagerDao.class);
      for (      Map.Entry<UUID,String> entry : shards.entrySet()) {
        long nodeId=getOrCreateNodeId(entry.getValue());
        UUID shardUuid=entry.getKey();
        long shardId=dao.insertShard(shardUuid);
        dao.insertShardNode(shardId,nodeId);
        dao.insertPartitionShard(shardId,tableId,partitionId);
      }
    }
  }
);
}
