{
  Stopwatch partitionTimer=new Stopwatch();
  partitionTimer.start();
  checkArgument(tableHandle instanceof NativeTableHandle,"Table must be a native table");
  TableMetadata tableMetadata=metadata.getTableMetadata(tableHandle);
  checkState(tableMetadata != null,"no metadata for %s found",tableHandle);
  Set<TablePartition> tablePartitions=shardManager.getPartitions(tableHandle);
  log.debug("Partition retrieval, native table %s (%d partitions): %dms",tableHandle,tablePartitions.size(),partitionTimer.elapsed(TimeUnit.MILLISECONDS));
  Multimap<String,? extends PartitionKey> allPartitionKeys=shardManager.getAllPartitionKeys(tableHandle);
  Map<String,ColumnHandle> columnHandles=metadata.getColumnHandles(tableHandle);
  log.debug("Partition key retrieval, native table %s (%d keys): %dms",tableHandle,allPartitionKeys.size(),partitionTimer.elapsed(TimeUnit.MILLISECONDS));
  List<Partition> partitions=ImmutableList.copyOf(Collections2.transform(tablePartitions,new PartitionFunction(columnHandles,allPartitionKeys)));
  log.debug("Partition generation, native table %s (%d partitions): %dms",tableHandle,partitions.size(),partitionTimer.elapsed(TimeUnit.MILLISECONDS));
  return partitions;
}
