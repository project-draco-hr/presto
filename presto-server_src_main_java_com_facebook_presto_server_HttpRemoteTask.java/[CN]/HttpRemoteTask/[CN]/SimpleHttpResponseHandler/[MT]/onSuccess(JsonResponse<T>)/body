{
  try {
    if (response.getStatusCode() == HttpStatus.OK.code() && response.hasValue()) {
      callback.success(response.getValue());
    }
 else     if (response.getStatusCode() == HttpStatus.SERVICE_UNAVAILABLE.code()) {
      callback.failed(new RuntimeException("Server at %s returned SERVICE_UNAVAILABLE"));
    }
 else {
      Exception cause=response.getException();
      if (cause == null) {
        if (response.getStatusCode() == HttpStatus.OK.code()) {
          cause=new RuntimeException(format("Expected response from %s is empty",uri));
        }
 else {
          cause=new RuntimeException(format("Expected response code from %s to be %s, but was %s: %s",uri,HttpStatus.OK.code(),response.getStatusCode(),response.getStatusMessage()));
        }
      }
      callback.fatal(cause);
    }
  }
 catch (  Throwable t) {
    callback.failed(t);
  }
}
