{
  CompilerContext context=new CompilerContext();
  MethodDefinition method=classDefinition.declareMethod(context,a(PUBLIC),"process",type(int.class),arg("session",ConnectorSession.class),arg("page",Page.class),arg("start",int.class),arg("end",int.class),arg("pageBuilder",PageBuilder.class));
  Variable sessionVariable=context.getVariable("session");
  Variable pageVariable=context.getVariable("page");
  Variable startVariable=context.getVariable("start");
  Variable endVariable=context.getVariable("end");
  Variable pageBuilderVariable=context.getVariable("pageBuilder");
  Variable positionVariable=context.declareVariable(int.class,"position");
  method.getBody().comment("int position = start;").getVariable(startVariable).putVariable(positionVariable);
  List<Integer> allInputChannels=getInputChannels(Iterables.concat(projections,ImmutableList.of(filter)));
  for (  int channel : allInputChannels) {
    Variable blockVariable=context.declareVariable(com.facebook.presto.spi.block.Block.class,"block_" + channel);
    method.getBody().comment("Block %s = page.getBlock(%s);",blockVariable.getName(),channel).getVariable(pageVariable).push(channel).invokeVirtual(Page.class,"getBlock",com.facebook.presto.spi.block.Block.class,int.class).putVariable(blockVariable);
  }
  LabelNode done=new LabelNode("done");
  Block loopBody=new Block(context);
  ForLoopBuilder loop=ForLoop.forLoopBuilder().initialize(NOP).condition(new Block(context).comment("position < end").getVariable(positionVariable).getVariable(endVariable).invokeStatic(CompilerOperations.class,"lessThan",boolean.class,int.class,int.class)).update(new Block(context).comment("position++").incrementVariable(positionVariable,(byte)1)).body(loopBody);
  loopBody.comment("if (pageBuilder.isFull()) break;").getVariable(pageBuilderVariable).invokeVirtual(PageBuilder.class,"isFull",boolean.class).ifTrueGoto(done);
  IfStatement filterBlock=new IfStatement();
  filterBlock.condition().append(context.getVariable("this")).getVariable(sessionVariable).append(pushBlockVariables(context,getInputChannels(filter))).getVariable(positionVariable).invokeVirtual(classDefinition.getType(),"filter",type(boolean.class),ImmutableList.<ParameterizedType>builder().add(type(ConnectorSession.class)).addAll(nCopies(getInputChannels(filter).size(),type(com.facebook.presto.spi.block.Block.class))).add(type(int.class)).build());
  filterBlock.ifTrue().getVariable(pageBuilderVariable).invokeVirtual(PageBuilder.class,"declarePosition",void.class);
  for (int projectionIndex=0; projectionIndex < projections.size(); projectionIndex++) {
    List<Integer> inputChannels=getInputChannels(projections.get(projectionIndex));
    filterBlock.ifTrue().append(context.getVariable("this")).getVariable(sessionVariable).append(pushBlockVariables(context,inputChannels)).getVariable(positionVariable);
    filterBlock.ifTrue().comment("pageBuilder.getBlockBuilder(" + projectionIndex + ")").getVariable(pageBuilderVariable).push(projectionIndex).invokeVirtual(PageBuilder.class,"getBlockBuilder",BlockBuilder.class,int.class);
    filterBlock.ifTrue().comment("project_" + projectionIndex + "(session, block_"+ inputChannels+ ", position, blockBuilder)").invokeVirtual(classDefinition.getType(),"project_" + projectionIndex,type(void.class),ImmutableList.<ParameterizedType>builder().add(type(ConnectorSession.class)).addAll(nCopies(inputChannels.size(),type(com.facebook.presto.spi.block.Block.class))).add(type(int.class)).add(type(BlockBuilder.class)).build());
  }
  loopBody.append(filterBlock);
  method.getBody().append(loop.build()).visitLabel(done).comment("return position;").getVariable(positionVariable).retInt();
}
