{
  PlanNode rewrittenSource=planRewriter.rewrite(node.getSource(),null);
  if (rewrittenSource == node.getSource() && limit == null) {
    return node;
  }
  long count=node.getCount();
  Optional<Symbol> sampleWeight=node.getSampleWeight();
  if (limit != null) {
    count=Math.min(count,limit.getCount());
    if (limit.getSampleWeight().isPresent()) {
      checkState(!sampleWeight.isPresent() || sampleWeight.equals(limit.getSampleWeight()),"limit and topN sample weight symbols don't match");
      sampleWeight=limit.getSampleWeight();
    }
  }
  return new TopNNode(node.getId(),rewrittenSource,count,node.getOrderBy(),node.getOrderings(),node.isPartial(),sampleWeight);
}
