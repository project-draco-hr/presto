{
  Multimap<Node,Split> assignment=HashMultimap.create();
  for (  Split split : splits) {
    List<Node> candidateNodes=selectCandidateNodes(nodeMap.get().get(),split);
    checkState(!candidateNodes.isEmpty(),"No nodes available to run query");
    Map<Node,Integer> splitsByNode=new HashMap<>();
    Node chosen=null;
    int min=Integer.MAX_VALUE;
    for (    Node node : candidateNodes) {
      Integer partitionedSplitCount=splitsByNode.get(node);
      if (partitionedSplitCount == null) {
        partitionedSplitCount=nodeTaskMap.getPartitionedSplitsOnNode(node);
        splitsByNode.put(node,partitionedSplitCount);
      }
      int assignedSplits=partitionedSplitCount + assignment.get(node).size();
      if (assignedSplits < min && assignedSplits < maxSplitsPerNode) {
        chosen=node;
        min=assignedSplits;
      }
    }
    if (chosen != null) {
      assignment.put(chosen,split);
    }
  }
  return assignment;
}
