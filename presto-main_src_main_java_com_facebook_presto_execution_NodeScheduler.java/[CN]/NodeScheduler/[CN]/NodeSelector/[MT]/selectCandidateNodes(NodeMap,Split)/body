{
  Set<Node> chosen=new LinkedHashSet<>(minCandidates);
  String coordinatorIdentifier=nodeManager.getCurrentNode().getNodeIdentifier();
  for (  HostAddress hint : split.getAddresses()) {
    for (    Node node : nodeMap.getNodesByHostAndPort().get(hint)) {
      if (includeCoordinator || !coordinatorIdentifier.equals(node.getNodeIdentifier())) {
        if (chosen.add(node)) {
          scheduleLocal.incrementAndGet();
        }
      }
    }
    InetAddress address;
    try {
      address=hint.toInetAddress();
    }
 catch (    UnknownHostException e) {
      continue;
    }
    if (!hint.hasPort() || split.isRemotelyAccessible()) {
      for (      Node node : nodeMap.getNodesByHost().get(address)) {
        if (includeCoordinator || !coordinatorIdentifier.equals(node.getNodeIdentifier())) {
          if (chosen.add(node)) {
            scheduleLocal.incrementAndGet();
          }
        }
      }
    }
  }
  if (split.isRemotelyAccessible() && chosen.size() < minCandidates) {
    for (    HostAddress hint : split.getAddresses()) {
      InetAddress address;
      try {
        address=hint.toInetAddress();
      }
 catch (      UnknownHostException e) {
        continue;
      }
      for (      Node node : nodeMap.getNodesByRack().get(Rack.of(address))) {
        if (includeCoordinator || !coordinatorIdentifier.equals(node.getNodeIdentifier())) {
          if (chosen.add(node)) {
            scheduleRack.incrementAndGet();
          }
          if (chosen.size() == minCandidates) {
            break;
          }
        }
      }
      if (chosen.size() == minCandidates) {
        break;
      }
    }
  }
  if (split.isRemotelyAccessible()) {
    if (chosen.size() < minCandidates) {
      for (      Node node : lazyShuffle(nodeMap.getNodesByHost().values())) {
        if (includeCoordinator || !coordinatorIdentifier.equals(node.getNodeIdentifier())) {
          if (chosen.add(node)) {
            scheduleRandom.incrementAndGet();
          }
          if (chosen.size() == minCandidates) {
            break;
          }
        }
      }
    }
  }
  if (chosen.isEmpty() && !includeCoordinator) {
    final HostAddress coordinatorHostAddress=nodeManager.getCurrentNode().getHostAndPort();
    if (FluentIterable.from(split.getAddresses()).anyMatch(new Predicate<HostAddress>(){
      @Override public boolean apply(      HostAddress hostAddress){
        if (hostAddress.equals(coordinatorHostAddress)) {
          return true;
        }
        return (!hostAddress.hasPort() || split.isRemotelyAccessible()) && hostAddress.getHostText().equals(coordinatorHostAddress.getHostText());
      }
    }
)) {
      chosen.add(nodeManager.getCurrentNode());
    }
  }
  return ImmutableList.copyOf(chosen);
}
