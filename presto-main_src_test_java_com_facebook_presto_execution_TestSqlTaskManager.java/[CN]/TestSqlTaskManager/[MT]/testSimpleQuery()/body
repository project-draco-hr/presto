{
  try (SqlTaskManager sqlTaskManager=createSqlTaskManager(new TaskManagerConfig())){
    TaskId taskId=TASK_ID;
    TaskInfo taskInfo=sqlTaskManager.updateTask(SESSION,taskId,PLAN_FRAGMENT,ImmutableList.of(new TaskSource(TABLE_SCAN_NODE_ID,ImmutableSet.of(SPLIT),true)),INITIAL_EMPTY_OUTPUT_BUFFERS.withBuffer(OUT,new UnpartitionedPagePartitionFunction()).withNoMoreBufferIds());
    assertEquals(taskInfo.getState(),TaskState.RUNNING);
    taskInfo=sqlTaskManager.getTaskInfo(taskId);
    assertEquals(taskInfo.getState(),TaskState.RUNNING);
    BufferResult results=sqlTaskManager.getTaskResults(taskId,OUT,0,new DataSize(1,Unit.MEGABYTE)).get();
    assertEquals(results.isBufferClosed(),false);
    assertEquals(results.getPages().size(),1);
    assertEquals(results.getPages().get(0).getPositionCount(),1);
    results=sqlTaskManager.getTaskResults(taskId,OUT,results.getToken() + results.getPages().size(),new DataSize(1,Unit.MEGABYTE)).get();
    assertEquals(results.isBufferClosed(),true);
    assertEquals(results.getPages().size(),0);
    taskInfo=sqlTaskManager.getTaskInfo(taskId,taskInfo.getState()).get(1,TimeUnit.SECONDS);
    assertEquals(taskInfo.getState(),TaskState.FINISHED);
    taskInfo=sqlTaskManager.getTaskInfo(taskId);
    assertEquals(taskInfo.getState(),TaskState.FINISHED);
  }
 }
