{
  checkNotNull(outputId,"outputId is null");
  checkArgument(maxSize.toBytes() > 0,"maxSize must be at least 1 byte");
  checkNotNull(maxWait,"maxWait is null");
  NamedQueue namedQueue=namedQueues.get(outputId);
  if (namedQueue == null) {
    throw new NoSuchBufferException(outputId,namedQueues.keySet());
  }
  if (state.get() == QueueState.FINISHED) {
    return emptyResults(namedQueue.getSequenceId(),true);
  }
  if (namedQueue.isEmpty()) {
    long remainingNanos=maxWait.roundTo(NANOSECONDS);
    long end=System.nanoTime() + remainingNanos;
    while (remainingNanos > 0 && namedQueue.isEmpty() && !namedQueue.isFinished()) {
      NANOSECONDS.timedWait(this,remainingNanos);
      remainingNanos=end - System.nanoTime();
    }
  }
  openQueuesBySequenceId.remove(namedQueue);
  BufferResult results=namedQueue.getPages(startingSequenceId,maxSize);
  if (!closed.get() || !results.isBufferClosed()) {
    openQueuesBySequenceId.add(namedQueue);
  }
 else {
    namedQueue.setFinished();
  }
  updateState();
  return results;
}
