{
  Long tableId=dbi.inTransaction(new TransactionCallback<Long>(){
    @Override public Long inTransaction(    final Handle handle,    TransactionStatus status) throws Exception {
      return runIgnoringConstraintViolation(new Callable<Long>(){
        @Override public Long call() throws Exception {
          MetadataDao dao=handle.attach(MetadataDao.class);
          long tableId=dao.insertTable(connectorId,tableMetadata.getTable().getSchemaName(),tableMetadata.getTable().getTableName());
          int ordinalPosition=0;
          for (          ColumnMetadata column : tableMetadata.getColumns()) {
            long columnId=ordinalPosition + 1;
            dao.insertColumn(tableId,columnId,column.getName(),ordinalPosition,column.getType().getName());
            ordinalPosition++;
          }
          if (tableMetadata.isSampled()) {
            dao.insertColumn(tableId,ordinalPosition + 1,NativeColumnHandle.SAMPLE_WEIGHT_COLUMN_NAME,ordinalPosition,BIGINT.getName());
          }
          return tableId;
        }
      }
,null);
    }
  }
);
  checkState(tableId != null,"table %s already exists",tableMetadata.getTable());
  NativeColumnHandle sampleWeightColumnHandle=null;
  if (tableMetadata.isSampled()) {
    sampleWeightColumnHandle=new NativeColumnHandle(NativeColumnHandle.SAMPLE_WEIGHT_COLUMN_NAME,tableMetadata.getColumns().size() + 1);
  }
  return new NativeTableHandle(tableMetadata.getTable().getSchemaName(),tableMetadata.getTable().getTableName(),tableId,sampleWeightColumnHandle);
}
