{
  checkNotNull(defaultSession,"defaultSession is null");
  try {
    discoveryServer=new TestingDiscoveryServer(ENVIRONMENT);
    ImmutableList.Builder<TestingPrestoServer> servers=ImmutableList.builder();
    coordinator=createTestingPrestoServer(discoveryServer.getBaseUrl(),true);
    servers.add(coordinator);
    for (int i=1; i < workersCount; i++) {
      servers.add(createTestingPrestoServer(discoveryServer.getBaseUrl(),false));
    }
    this.servers=servers.build();
  }
 catch (  Exception e) {
    close();
    throw e;
  }
  this.prestoClient=new TestingPrestoClient(coordinator,defaultSession);
  long start=System.nanoTime();
  while (!allNodesGloballyVisible()) {
    Assertions.assertLessThan(nanosSince(start),new Duration(10,SECONDS));
    MILLISECONDS.sleep(10);
  }
  for (  TestingPrestoServer server : servers) {
    server.getMetadata().addFunctions(AbstractTestQueries.CUSTOM_FUNCTIONS);
  }
}
