{
  this.taskId=checkNotNull(taskId,"taskId is null");
  this.nodeInstanceId=checkNotNull(nodeInstanceId,"nodeInstanceId is null");
  this.location=checkNotNull(location,"location is null");
  this.queryContext=requireNonNull(queryContext,"queryContext is null");
  this.sqlTaskExecutionFactory=checkNotNull(sqlTaskExecutionFactory,"sqlTaskExecutionFactory is null");
  checkNotNull(taskNotificationExecutor,"taskNotificationExecutor is null");
  checkNotNull(onDone,"onDone is null");
  checkNotNull(maxBufferSize,"maxBufferSize is null");
  sharedBuffer=new SharedBuffer(taskId,taskNotificationExecutor,maxBufferSize);
  taskStateMachine=new TaskStateMachine(taskId,taskNotificationExecutor);
  taskStateMachine.addStateChangeListener(new StateChangeListener<TaskState>(){
    @Override public void stateChanged(    TaskState newState){
      if (!newState.isDone()) {
        return;
      }
      while (true) {
        TaskHolder taskHolder=taskHolderReference.get();
        if (taskHolder.isFinished()) {
          return;
        }
        if (taskHolderReference.compareAndSet(taskHolder,new TaskHolder(createTaskInfo(taskHolder),taskHolder.getIoStats()))) {
          break;
        }
      }
      if (newState == TaskState.FAILED || newState == TaskState.ABORTED) {
        sharedBuffer.fail();
      }
 else {
        sharedBuffer.destroy();
      }
      try {
        onDone.apply(SqlTask.this);
      }
 catch (      Exception e) {
        log.warn(e,"Error running task cleanup callback %s",SqlTask.this.taskId);
      }
    }
  }
);
}
