{
  Object value=process(node.getValue(),context);
  if (value == null) {
    return null;
  }
  if (value instanceof Slice && node.getPattern() instanceof StringLiteral && (node.getEscape() instanceof StringLiteral || node.getEscape() == null)) {
    Slice valueSlice=(Slice)value;
    Matcher matcher=getConstantPattern(node).matcher(valueSlice.getBytes());
    return matcher.match(0,valueSlice.length(),Option.NONE) != -1;
  }
  Object pattern=process(node.getPattern(),context);
  if (pattern == null) {
    return null;
  }
  Object escape=null;
  if (node.getEscape() != null) {
    escape=process(node.getEscape(),context);
    if (escape == null) {
      return null;
    }
  }
  if (value instanceof Slice && pattern instanceof Slice && (escape == null || escape instanceof Slice)) {
    String patternString=((Slice)pattern).toString(UTF_8);
    char escapeChar='\\';
    if (escape != null) {
      escapeChar=getEscapeChar((Slice)escape);
    }
    Regex regex=likeToPattern(patternString,escapeChar);
    Slice valueSlice=(Slice)value;
    Matcher matcher=regex.matcher(valueSlice.getBytes());
    return matcher.match(0,valueSlice.length(),Option.NONE) != -1;
  }
  if (pattern instanceof Slice && escape == null) {
    String stringPattern=((Slice)pattern).toString(Charsets.UTF_8);
    if (!stringPattern.contains("%") && !stringPattern.contains("_")) {
      return new ComparisonExpression(ComparisonExpression.Type.EQUAL,toExpression(value),toExpression(pattern));
    }
  }
  Expression optimizedEscape=null;
  if (node.getEscape() != null) {
    optimizedEscape=toExpression(escape);
  }
  return new LikePredicate(toExpression(value),toExpression(pattern),optimizedEscape);
}
