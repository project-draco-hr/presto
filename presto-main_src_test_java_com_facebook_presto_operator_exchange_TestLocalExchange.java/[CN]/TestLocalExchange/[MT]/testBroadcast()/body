{
  LocalExchange exchange=new LocalExchange(FIXED_BROADCAST_DISTRIBUTION,2,TYPES,ImmutableList.of(),Optional.empty());
  assertEquals(exchange.getBufferCount(),2);
  assertExchangeTotalBufferPages(exchange,0);
  LocalExchangeSinkFactory sinkFactory=exchange.createSinkFactory();
  LocalExchangeSink sinkA=sinkFactory.createSink();
  assertSinkCanWrite(sinkA);
  LocalExchangeSink sinkB=sinkFactory.createSink();
  assertSinkCanWrite(sinkB);
  sinkFactory.close();
  sinkFactory.noMoreSinkFactories();
  LocalExchangeSource sourceA=exchange.getSource(0);
  assertSource(sourceA,0);
  LocalExchangeSource sourceB=exchange.getSource(1);
  assertSource(sourceB,0);
  sinkA.addPage(createPage(0));
  assertSource(sourceA,1);
  assertSource(sourceB,1);
  assertExchangeTotalBufferPages(exchange,1);
  sinkA.addPage(createPage(0));
  assertSource(sourceA,2);
  assertSource(sourceB,2);
  assertExchangeTotalBufferPages(exchange,2);
  assertRemovePage(sourceA,createPage(0));
  assertSource(sourceA,1);
  assertSource(sourceB,2);
  assertExchangeTotalBufferPages(exchange,2);
  assertRemovePage(sourceA,createPage(0));
  assertSource(sourceA,0);
  assertSource(sourceB,2);
  assertExchangeTotalBufferPages(exchange,2);
  sinkA.finish();
  assertSinkFinished(sinkA);
  assertExchangeTotalBufferPages(exchange,2);
  sinkB.addPage(createPage(0));
  assertSource(sourceA,1);
  assertSource(sourceB,3);
  assertExchangeTotalBufferPages(exchange,3);
  sinkB.finish();
  assertSinkFinished(sinkB);
  assertSource(sourceA,1);
  assertSource(sourceB,3);
  assertExchangeTotalBufferPages(exchange,3);
  assertRemovePage(sourceA,createPage(0));
  assertSourceFinished(sourceA);
  assertSource(sourceB,3);
  assertExchangeTotalBufferPages(exchange,3);
  assertRemovePage(sourceB,createPage(0));
  assertRemovePage(sourceB,createPage(0));
  assertSourceFinished(sourceA);
  assertSource(sourceB,1);
  assertExchangeTotalBufferPages(exchange,1);
  assertRemovePage(sourceB,createPage(0));
  assertSourceFinished(sourceA);
  assertSourceFinished(sourceB);
  assertExchangeTotalBufferPages(exchange,0);
}
