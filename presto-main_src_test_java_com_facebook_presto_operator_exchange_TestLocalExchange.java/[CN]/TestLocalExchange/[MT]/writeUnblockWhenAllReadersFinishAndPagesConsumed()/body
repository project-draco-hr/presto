{
  LocalExchange exchange=new LocalExchange(fixedBroadcastPartitioning(),2,TYPES,ImmutableList.of(),Optional.empty(),new DataSize(1,BYTE));
  assertEquals(exchange.getBufferCount(),2);
  assertExchangeTotalBufferedBytes(exchange,0);
  LocalExchangeSinkFactory sinkFactory=exchange.createSinkFactory();
  LocalExchangeSink sinkA=sinkFactory.createSink();
  assertSinkCanWrite(sinkA);
  LocalExchangeSink sinkB=sinkFactory.createSink();
  assertSinkCanWrite(sinkB);
  sinkFactory.close();
  sinkFactory.noMoreSinkFactories();
  LocalExchangeSource sourceA=exchange.getSource(0);
  assertSource(sourceA,0);
  LocalExchangeSource sourceB=exchange.getSource(1);
  assertSource(sourceB,0);
  sinkA.addPage(createPage(0));
  ListenableFuture<?> sinkAFuture=assertSinkWriteBlocked(sinkA);
  ListenableFuture<?> sinkBFuture=assertSinkWriteBlocked(sinkB);
  assertSource(sourceA,1);
  assertSource(sourceB,1);
  assertExchangeTotalBufferedBytes(exchange,1);
  sourceA.finish();
  assertSource(sourceA,1);
  assertRemovePage(sourceA,createPage(0));
  assertSourceFinished(sourceA);
  assertExchangeTotalBufferedBytes(exchange,1);
  assertSource(sourceB,1);
  assertSinkWriteBlocked(sinkA);
  assertSinkWriteBlocked(sinkB);
  sourceB.finish();
  assertSource(sourceB,1);
  assertRemovePage(sourceB,createPage(0));
  assertSourceFinished(sourceB);
  assertExchangeTotalBufferedBytes(exchange,0);
  assertTrue(sinkAFuture.isDone());
  assertTrue(sinkBFuture.isDone());
  assertSinkFinished(sinkA);
  assertSinkFinished(sinkB);
}
