{
  LocalExchange exchange=new LocalExchange(fixedHashPartitioning(2,ImmutableList.of()),TYPES,ImmutableList.of(0),Optional.empty());
  assertEquals(exchange.getBufferCount(),2);
  assertExchangeTotalBufferedBytes(exchange,0);
  LocalExchangeSinkFactory sinkFactory=exchange.createSinkFactory();
  LocalExchangeSink sink=sinkFactory.createSink();
  assertSinkCanWrite(sink);
  sinkFactory.close();
  sinkFactory.noMoreSinkFactories();
  LocalExchangeSource sourceA=exchange.getSource(0);
  assertSource(sourceA,0);
  LocalExchangeSource sourceB=exchange.getSource(1);
  assertSource(sourceB,0);
  sink.addPage(createPage(0));
  assertSource(sourceA,1);
  assertSource(sourceB,1);
  assertTrue(exchange.getBufferedBytes() >= retainedSizeOfPages(1));
  sink.addPage(createPage(0));
  assertSource(sourceA,2);
  assertSource(sourceB,2);
  assertTrue(exchange.getBufferedBytes() >= retainedSizeOfPages(2));
  assertPartitionedRemovePage(sourceA,0,2);
  assertSource(sourceA,1);
  assertSource(sourceB,2);
  assertPartitionedRemovePage(sourceA,0,2);
  assertSource(sourceA,0);
  assertSource(sourceB,2);
  sink.finish();
  assertSinkFinished(sink);
  assertSourceFinished(sourceA);
  assertSource(sourceB,2);
  assertPartitionedRemovePage(sourceB,1,2);
  assertSourceFinished(sourceA);
  assertSource(sourceB,1);
  assertPartitionedRemovePage(sourceB,1,2);
  assertSourceFinished(sourceA);
  assertSourceFinished(sourceB);
  assertExchangeTotalBufferedBytes(exchange,0);
}
