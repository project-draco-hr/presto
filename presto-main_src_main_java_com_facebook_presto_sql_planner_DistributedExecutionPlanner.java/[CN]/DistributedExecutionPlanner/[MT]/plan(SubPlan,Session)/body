{
  PlanFragment currentFragment=root.getFragment();
  Visitor visitor=new Visitor(session);
  Optional<SplitSource> splits=currentFragment.getRoot().accept(visitor,null);
  ImmutableList.Builder<StageExecutionPlan> dependencies=ImmutableList.builder();
  for (  SubPlan childPlan : root.getChildren()) {
    dependencies.add(plan(childPlan,session));
  }
  Optional<PartitioningHandle> partitioningHandle=Optional.empty();
  if (currentFragment.getDistribution() != SOURCE) {
    partitioningHandle=Optional.of(new SystemPartitioningHandle(currentFragment.getDistribution()));
  }
  return new StageExecutionPlan(currentFragment,splits,partitioningHandle,dependencies.build());
}
