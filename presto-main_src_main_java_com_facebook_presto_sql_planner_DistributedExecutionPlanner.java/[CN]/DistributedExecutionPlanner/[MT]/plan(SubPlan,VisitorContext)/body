{
  PlanFragment currentFragment=root.getFragment();
  Visitor visitor=new Visitor();
  Optional<Iterable<SplitAssignments>> splits=currentFragment.getRoot().accept(visitor,context);
  ImmutableList.Builder<StageExecutionPlan> dependencies=ImmutableList.builder();
  for (  SubPlan childPlan : root.getChildren()) {
    Expression predicate=visitor.getInheritedPredicatesBySourceFragmentId().get(childPlan.getFragment().getId());
    Preconditions.checkNotNull(predicate,"Expected to find a predicate for fragment %s",childPlan.getFragment().getId());
    StageExecutionPlan dependency=plan(childPlan,new VisitorContext(predicate,context.getPartitionPredicate()));
    dependencies.add(dependency);
  }
  return new StageExecutionPlan(currentFragment,splits,dependencies.build(),visitor.getOutputReceivers());
}
