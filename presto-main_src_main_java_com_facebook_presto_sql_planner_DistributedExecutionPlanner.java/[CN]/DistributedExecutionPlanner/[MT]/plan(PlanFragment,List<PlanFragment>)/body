{
  List<Partition> partitions;
  if (currentFragment.isPartitioned()) {
    partitions=getPartitions(currentFragment.getRoot());
  }
 else {
    ArrayList<Node> nodes=new ArrayList<>(nodeManager.getActiveNodes());
    Preconditions.checkState(!nodes.isEmpty(),"Cluster does not have any active nodes");
    Collections.shuffle(nodes,random);
    Node node=nodes.get(0);
    partitions=ImmutableList.of(new Partition(node,ImmutableList.<PlanFragmentSource>of()));
  }
  ImmutableList.Builder<Stage> dependencies=ImmutableList.builder();
  for (  PlanFragment childPlanFragment : getChildPlanFragments(currentFragment.getRoot(),allFragments)) {
    Stage dependency=plan(childPlanFragment,allFragments);
    dependencies.add(dependency);
  }
  return new Stage(currentFragment,partitions,dependencies.build());
}
