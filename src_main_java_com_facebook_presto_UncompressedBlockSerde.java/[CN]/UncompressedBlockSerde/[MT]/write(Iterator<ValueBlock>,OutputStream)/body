{
  DynamicSliceOutput buffer=new DynamicSliceOutput(MAX_BLOCK_SIZE);
  int tupleCount=0;
  TupleInfo tupleInfo=null;
  while (iterator.hasNext()) {
    ValueBlock valueBlock=iterator.next();
    for (    Tuple tuple : valueBlock) {
      if (tupleInfo == null) {
        tupleInfo=tuple.getTupleInfo();
        UncompressedTupleInfoSerde.serialize(tupleInfo,new OutputStreamSliceOutput(out));
      }
 else {
        Preconditions.checkState(tupleInfo.equals(tuple.getTupleInfo()),"Expected %s, but got %s",tupleInfo,tuple.getTupleInfo());
      }
      tuple.writeTo(buffer);
      tupleCount++;
      if (buffer.size() > MAX_BLOCK_SIZE) {
        write(out,tupleCount,buffer.slice());
        tupleCount=0;
        buffer=new DynamicSliceOutput(MAX_BLOCK_SIZE);
      }
    }
  }
  if (buffer.size() > 0) {
    write(out,tupleCount,buffer.slice());
  }
}
