{
  SubPlanBuilder subPlanBuilder=node.getSource().accept(this,context);
  if (createSingleNodePlan) {
    subPlanBuilder.setRoot(new TableWriterNode(node.getId(),subPlanBuilder.getRoot(),node.getTable(),node.getColumns(),node.getOutput()));
  }
 else {
    FunctionInfo sum=metadata.getFunction(QualifiedName.of("sum"),Lists.transform(ImmutableList.of(Type.LONG),Type.toRaw()));
    Symbol intermediateOutput=allocator.newSymbol(node.getOutput().toString(),Type.fromRaw(sum.getReturnType()));
    TableWriterNode writer=new TableWriterNode(node.getId(),subPlanBuilder.getRoot(),node.getTable(),node.getColumns(),intermediateOutput);
    subPlanBuilder.setRoot(writer).addPartitionedSource(node.getId());
    FunctionCall aggregate=new FunctionCall(sum.getName(),ImmutableList.<Expression>of(new QualifiedNameReference(intermediateOutput.toQualifiedName())));
    return addDistributedAggregation(subPlanBuilder,ImmutableMap.of(node.getOutput(),aggregate),ImmutableMap.of(node.getOutput(),sum.getHandle()),ImmutableList.<Symbol>of());
  }
  return subPlanBuilder;
}
