{
  Preconditions.checkNotNull(doneState,"doneState is null");
  Preconditions.checkArgument(doneState.isDone(),"doneState %s is not a done state",doneState);
  while (true) {
    TaskState currentTaskState=this.taskState.get();
    if (currentTaskState.isDone()) {
      return false;
    }
    stats.recordEnd();
    if (taskState.compareAndSet(currentTaskState,doneState)) {
      if (doneState != TaskState.FAILED) {
        sharedBuffer.destroy();
      }
      return true;
    }
  }
}
