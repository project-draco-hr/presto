{
  this.taskStateMachine=requireNonNull(taskStateMachine,"taskStateMachine is null");
  this.taskId=taskStateMachine.getTaskId();
  this.taskContext=requireNonNull(taskContext,"taskContext is null");
  this.sharedBuffer=requireNonNull(sharedBuffer,"sharedBuffer is null");
  this.taskExecutor=requireNonNull(taskExecutor,"driverExecutor is null");
  this.notificationExecutor=requireNonNull(notificationExecutor,"notificationExecutor is null");
  this.queryMonitor=requireNonNull(queryMonitor,"queryMonitor is null");
  try (SetThreadName ignored=new SetThreadName("Task-%s",taskId)){
    List<DriverFactory> driverFactories;
    try {
      OutputFactory outputOperatorFactory;
switch (fragment.getOutputPartitioning()) {
case NONE:
        outputOperatorFactory=new TaskOutputFactory(sharedBuffer);
      break;
case HASH:
case ROUND_ROBIN:
    outputOperatorFactory=new PartitionedOutputFactory(sharedBuffer);
  break;
default :
throw new PrestoException(NOT_SUPPORTED,format("OutputPartitioning %s is not supported",fragment.getOutputPartitioning()));
}
LocalExecutionPlan localExecutionPlan=planner.plan(taskContext.getSession(),fragment.getRoot(),fragment.getOutputLayout(),fragment.getSymbols(),fragment.getDistribution(),outputOperatorFactory);
driverFactories=localExecutionPlan.getDriverFactories();
}
 catch (Throwable e) {
taskStateMachine.failed(e);
throw Throwables.propagate(e);
}
DriverSplitRunnerFactory partitionedDriverFactory=null;
ImmutableList.Builder<DriverSplitRunnerFactory> unpartitionedDriverFactories=ImmutableList.builder();
for (DriverFactory driverFactory : driverFactories) {
if (driverFactory.getSourceIds().contains(fragment.getPartitionedSource())) {
checkState(partitionedDriverFactory == null,"multiple partitioned sources are not supported");
partitionedDriverFactory=new DriverSplitRunnerFactory(driverFactory);
}
 else {
unpartitionedDriverFactories.add(new DriverSplitRunnerFactory(driverFactory));
}
}
this.unpartitionedDriverFactories=unpartitionedDriverFactories.build();
if (fragment.getDistribution() == PlanDistribution.SOURCE) {
checkArgument(partitionedDriverFactory != null,"Fragment is partitioned, but no partitioned driver found");
}
this.partitionedSourceId=fragment.getPartitionedSource();
this.partitionedDriverFactory=partitionedDriverFactory;
if (!taskStateMachine.getState().isDone()) {
taskHandle=taskExecutor.addTask(taskId);
taskStateMachine.addStateChangeListener(new RemoveTaskHandleWhenDone(taskExecutor,taskHandle));
}
 else {
taskHandle=null;
}
sharedBuffer.addStateChangeListener(new CheckTaskCompletionOnBufferFinish(SqlTaskExecution.this));
}
 }
