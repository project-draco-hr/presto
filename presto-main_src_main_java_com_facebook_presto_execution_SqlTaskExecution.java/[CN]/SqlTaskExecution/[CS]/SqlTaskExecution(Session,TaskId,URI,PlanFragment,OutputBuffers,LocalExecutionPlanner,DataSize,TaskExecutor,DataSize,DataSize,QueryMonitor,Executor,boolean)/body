{
  try (SetThreadName setThreadName=new SetThreadName("Task-%s",taskId)){
    this.taskId=checkNotNull(taskId,"taskId is null");
    this.location=checkNotNull(location,"location is null");
    this.taskExecutor=checkNotNull(taskExecutor,"driverExecutor is null");
    this.taskStateMachine=new TaskStateMachine(taskId,notificationExecutor);
    taskStateMachine.addStateChangeListener(new StateChangeListener<TaskState>(){
      @Override public void stateChanged(      TaskState taskState){
        if (taskState.isDone()) {
          SqlTaskExecution.this.taskExecutor.removeTask(taskHandle);
          sharedBuffer.destroy();
        }
      }
    }
);
    this.taskContext=new TaskContext(taskStateMachine,notificationExecutor,session,checkNotNull(maxTaskMemoryUsage,"maxTaskMemoryUsage is null"),checkNotNull(operatorPreAllocatedMemory,"operatorPreAllocatedMemory is null"),cpuTimerEnabled);
    this.sharedBuffer=new SharedBuffer(checkNotNull(maxBufferSize,"maxBufferSize is null"),outputBuffers);
    this.queryMonitor=checkNotNull(queryMonitor,"queryMonitor is null");
    taskHandle=taskExecutor.addTask(taskId);
    LocalExecutionPlan localExecutionPlan=planner.plan(session,fragment.getRoot(),fragment.getSymbols(),new TaskOutputFactory(sharedBuffer));
    List<DriverFactory> driverFactories=localExecutionPlan.getDriverFactories();
    DriverFactory partitionedDriverFactory=null;
    List<Driver> unpartitionedDrivers=new ArrayList<>();
    List<DriverFactory> unpartitionedDriverFactories=new ArrayList<>();
    for (    DriverFactory driverFactory : driverFactories) {
      if (driverFactory.getSourceIds().contains(fragment.getPartitionedSource())) {
        partitionedDriverFactory=driverFactory;
      }
 else {
        PipelineContext pipelineContext=taskContext.addPipelineContext(driverFactory.isInputDriver(),driverFactory.isOutputDriver());
        Driver driver=driverFactory.createDriver(pipelineContext.addDriverContext());
        unpartitionedDrivers.add(driver);
        unpartitionedDriverFactories.add(driverFactory);
      }
    }
    this.unpartitionedDrivers=ImmutableList.copyOf(unpartitionedDrivers);
    this.unpartitionedDriverFactories=ImmutableList.copyOf(unpartitionedDriverFactories);
    if (fragment.getDistribution() == PlanDistribution.SOURCE) {
      checkArgument(partitionedDriverFactory != null,"Fragment is partitioned, but no partitioned driver found");
      this.partitionedSourceId=fragment.getPartitionedSource();
      this.partitionedDriverFactory=partitionedDriverFactory;
      this.partitionedPipelineContext=taskContext.addPipelineContext(partitionedDriverFactory.isInputDriver(),partitionedDriverFactory.isOutputDriver());
    }
 else {
      this.partitionedSourceId=null;
      this.partitionedDriverFactory=null;
      this.partitionedPipelineContext=null;
    }
  }
 }
