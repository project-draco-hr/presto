{
  Map<PlanNodeId,TaskSource> updatedUnpartitionedSources=new HashMap<>();
  long newMaxAcknowledgedSplit=maxAcknowledgedSplit;
  for (  TaskSource source : sources) {
    PlanNodeId sourceId=source.getPlanNodeId();
    if (sourceId.equals(partitionedSourceId)) {
      for (      final ScheduledSplit scheduledSplit : source.getSplits()) {
        if (scheduledSplit.getSequenceId() > maxAcknowledgedSplit) {
          enqueueDriver(false,true,new DriverSplitRunner(partitionedPipelineContext.addDriverContext(),new Function<DriverContext,Driver>(){
            @Override public Driver apply(            DriverContext driverContext){
              return createDriver(partitionedDriverFactory,driverContext,scheduledSplit);
            }
          }
));
          newMaxAcknowledgedSplit=max(scheduledSplit.getSequenceId(),newMaxAcknowledgedSplit);
        }
      }
      if (source.isNoMoreSplits()) {
        noMorePartitionedSplits.set(true);
        checkNoMorePartitionedSplits();
      }
    }
 else {
      for (      ScheduledSplit scheduledSplit : source.getSplits()) {
        newMaxAcknowledgedSplit=max(scheduledSplit.getSequenceId(),newMaxAcknowledgedSplit);
      }
      TaskSource newSource;
      TaskSource currentSource=unpartitionedSources.get(sourceId);
      if (currentSource == null) {
        newSource=source;
      }
 else {
        newSource=currentSource.update(source);
      }
      if (newSource != currentSource) {
        unpartitionedSources.put(sourceId,newSource);
        updatedUnpartitionedSources.put(sourceId,newSource);
      }
    }
  }
  maxAcknowledgedSplit=newMaxAcknowledgedSplit;
  return updatedUnpartitionedSources;
}
