{
  NodeSelector nodeSelector=nodeScheduler.createNodeSelector(null);
  List<Node> nodes;
  if (partitioning == SystemPartitioning.COORDINATOR_ONLY) {
    nodes=ImmutableList.of(nodeSelector.selectCurrentNode());
  }
 else   if (partitioning == SystemPartitioning.SINGLE) {
    nodes=nodeSelector.selectRandomNodes(1);
  }
 else   if (partitioning == SystemPartitioning.FIXED) {
    nodes=nodeSelector.selectRandomNodes(getHashPartitionCount(session));
  }
 else {
    throw new IllegalArgumentException("Unsupported plan distribution " + partitioning);
  }
  checkCondition(!nodes.isEmpty(),NO_NODES_AVAILABLE,"No worker nodes available");
  ImmutableMap.Builder<Integer,Node> partitionToNode=ImmutableMap.builder();
  for (int i=0; i < nodes.size(); i++) {
    Node node=nodes.get(i);
    partitionToNode.put(i,node);
  }
  return new NodePartitionMap(partitionToNode.build());
}
